# 間欠的AI機能エラー修正ガイド

## 🚨 問題の状況
- **1回目**: AI機能が正常に動作
- **2回目以降**: 「non-2xx status code」エラーが発生

## 🔍 原因の特定

### 1. レート制限 (最も可能性が高い)
**症状**: 短時間での連続API呼び出し
**解決済み**: 待機時間を1秒→2秒に延長

### 2. API使用量制限
**症状**: 月間/日間制限に達した
**確認方法**: 各API Dashboard で使用量を確認

### 3. セッション/認証の問題
**症状**: 認証トークンの期限切れ
**確認方法**: Supabase Dashboard でセッション状態を確認

### 4. Edge Functionsのタイムアウト
**症状**: 処理時間が長すぎる
**確認方法**: Supabase Dashboard でログを確認

## 🔧 実装済みの改善

### 1. レート制限の改善
```javascript
// 変更前
await sleep(1000); // 1秒待機

// 変更後
await sleep(2000); // 2秒待機に延長
```

### 2. エラーハンドリングの強化
- レート制限エラーの検出
- 自動リトライ機能
- 詳細なエラーログ

## 🎯 即座に試せる解決方法

### Step 1: ブラウザキャッシュクリア
```bash
Ctrl+Shift+R  # ハードリフレッシュ
```

### Step 2: 待機時間を確認
- AI機能を使用する際に、前回の使用から2秒以上待機
- 連続使用を避ける

### Step 3: 開発者ツールでエラー確認
1. F12で開発者ツールを開く
2. Console タブでエラーメッセージを確認
3. Network タブでリクエストの詳細を確認

## 📋 確認すべき項目

### 1. API使用量の確認
- **OpenAI Dashboard**: https://platform.openai.com/usage
- **Groq Dashboard**: https://console.groq.com/usage
- **Google Cloud Console**: https://console.cloud.google.com/

### 2. Supabase Dashboard確認
- プロジェクト `nnbdzwrndqtsfzobknmj` がアクティブ
- Edge Functions がデプロイ済み
- APIキーが設定済み

### 3. ブラウザ確認
- ハードリフレッシュ実行済み
- キャッシュクリア済み
- 開発者ツールでエラー確認済み

## 🚀 テスト方法

### 1. 段階的テスト
1. **1回目**: AI機能を1回使用
2. **2秒待機**: 必ず2秒以上待機
3. **2回目**: AI機能を再度使用
4. **結果確認**: エラーが発生するか確認

### 2. 詳細テスト
1. 開発者ツールを開く
2. Network タブでリクエストを監視
3. エラーが発生した場合の詳細を記録

## 🔍 デバッグ情報の収集

### エラーが発生した場合の確認項目
1. **ステータスコード**: 404, 500, 401, 403など
2. **エラーメッセージ**: 詳細な内容
3. **リクエストURL**: 正しいURLか
4. **レスポンス内容**: エラーの詳細
5. **タイムスタンプ**: エラー発生時刻

### ログの確認方法
```javascript
// ブラウザの開発者ツールで実行
console.log('現在のSupabase設定:', window.APP_CONFIG);
console.log('Supabaseクライアント:', window.sb);
```

## 📞 次のステップ

### 問題が解決しない場合
1. 具体的なエラーメッセージを記録
2. ステータスコードを確認
3. リクエストURLを確認
4. レスポンス内容を確認

### 追加の改善案
1. 待機時間をさらに延長 (3-5秒)
2. 指数バックオフの実装
3. エラー時の自動リトライ機能
4. より詳細なエラーログ

## 🎯 成功の確認

AI機能が正常に動作する場合:
- 1回目の使用: 成功
- 2秒待機
- 2回目の使用: 成功
- エラーメッセージが表示されない

この状態になれば、問題は解決されています。
