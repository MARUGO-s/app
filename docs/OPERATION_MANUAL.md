# 取扱説明書（運用マニュアル）

このドキュメントは、**「CSV（仕入れマスタ）」「材料マスター（内容量・袋単価）」「在庫管理（棚卸し）」「仕込みカレンダー」「発注リスト」「レシピ入力」**が、同じルール（優先順位・単位換算）でつながるように整理した運用ガイドです。

> 対象: 現場運用者 / 管理者  
> 目的: 迷ったときに“ここを見れば一貫して判断できる”状態にする  

---

## 0. 用語

- **CSV（仕入れマスタ）**
  - Supabase Storage（`app-data` バケット）にアップロードされた仕入れCSV。
  - 材料名・価格・業者名・（ある場合は）単位を含む。
- **材料マスター（材料マスター管理）**
  - `unit_conversions` テーブルで管理する「内容量」と「袋/本/箱など1単位あたりの仕入れ値」。
  - 例: `テロワール` → `packetSize=25000` / `packetUnit=g` / `lastPrice=10900`（= 25kg袋の価格）
- **元の単位（CSV）**
  - 仕入れCSV側の「発注の単位」を指す（袋/本/箱…など）。
  - CSVに入っていない、または不正確な場合がある。
- **元の単位（CSV）上書き**
  - CSVに単位が無い/不明なときに、人が入力して補完する単位。
  - `csv_unit_overrides` テーブルに保存する（※マイグレーション適用が必要）。
- **在庫（棚卸し）**
  - `inventory_items` テーブルの在庫データ。  
  - 在庫画面では、CSVにある材料も「未登録（phantom）」として一覧に出る。

---

## 1. 大原則（優先順位と“単位・単価の意味”）

### 1-1. 優先順位（材料に紐づく情報）

材料名が一致する場合、基本の優先順位は以下です。

1) **材料マスター（unit_conversions）**  
   - 内容量（`packetSize` / `packetUnit`）と袋単価（`lastPrice`）  
2) **元の単位（CSV）上書き（csv_unit_overrides）**  
   - 発注単位の補完（袋/本/箱…）  
3) **CSV（仕入れマスタ）**  
   - 価格・業者・単位（入っている場合）  
4) **手入力（在庫/レシピ）**

### 1-2. 単価の意味（重要）

- **在庫管理の `price`**  
  - `price × quantity` が在庫金額になる前提。  
  - つまり `price` は **在庫の `unit` に対する単価**である必要があります。

- **材料マスターの `lastPrice`**  
  - **「1袋/1本/1箱（= 1発注単位）の合計価格」**です。  
  - そのため在庫計算に使うには、`packetSize` で割って **単位あたり単価**に正規化します。

例:
- `テロワール` 25,000g が 10,900円  
  - 正規化単価 = \( 10900 / 25000 = 0.436 \) 円/g  
  - 在庫金額（25,000g）= 0.436 × 25,000 = 10,900円

---

## 2. データ管理（CSV）

### 2-1. できること
- 仕入れCSVをアップロードして、材料名から参照できるようにする。
- CSVは複数ファイルを持てる（最新日付を優先して統合）。

### 2-2. 推奨運用
- 材料名の表記ゆれを減らす（例: 全角/半角、空白、末尾スペース）。
- **発注単位（袋/本/箱…）がCSVに無い場合**は、後述の「元の単位（CSV）上書き」で補完する。

---

## 3. 材料マスター管理（最優先の軸）

### 3-1. 目的
材料マスターは、在庫・レシピ・発注リストのすべての“計算の基準”になります。

- **内容量（packetSize / packetUnit）**: 1袋/1本あたりの量（g/mlなど）
- **仕入れ値（lastPrice）**: 1袋/1本あたりの価格（合計）

これにより、以下が一貫します。
- 在庫金額（単価×在庫数）の算定
- 発注の単位（袋/本）と2割ルール
- レシピ入力の自動参照（原価計算）

### 3-2. 画面の列
- **材料名**
- **仕入れ値（円）**: `lastPrice`
- **内容量**: `packetSize`
- **単位**: `packetUnit`
- **元の単位（CSV）**: CSVから読めた単位／または上書き入力（後述）
- **換算単価**: 目安表示（例: `¥390/kg` / `¥7,420/L` など）

### 3-3. 元の単位（CSV）が分からない/欠けている場合
CSVに発注単位（袋/本/箱…）が無い場合があります。その場合は材料マスター画面の **「元の単位（CSV）」列だけを直接編集**して補完します。

- 入力してフォーカスを外す（blur）と保存されます
- 保存先は `csv_unit_overrides` テーブルです

> 注意: `csv_unit_overrides` は新規テーブルです。Supabaseにマイグレーションを適用していない場合、保存時にエラーになります。  
> 適用ファイル: `supabase/migrations/20260202160000_create_csv_unit_overrides.sql`

---

## 4. 在庫管理（棚卸し）

### 4-1. 基本
- 在庫は `inventory_items` に保存されます。
- 仕入れCSVにある材料は、DB未登録でも **一覧に“未登録（phantom）”として表示**されます。
- ページに入った時、業者フィルタは **「すべて」** が初期状態です。

### 4-2. 在庫画面での“材料マスター優先”の挙動
材料名が材料マスターに存在する場合、在庫画面では以下が優先されます。

- **単価（price）**: `lastPrice / packetSize` で正規化した単価を使用（在庫の計算が壊れない）
- **内容量（表示）**: `packetSize + packetUnit` を「内容量」列に表示
- **単位の正規化（本→mlなど）**
  - 在庫の単位が **本/袋/個…** のような「個数単位」になっていて、
  - 材料マスターが **g/ml** のような「量」を持っている場合は、
  - 在庫の単位を master の単位へ変更し、在庫数も内容量で換算します  
    - 例: `1本` ＋ `1本=750ml` → 在庫は `750ml` として扱う

### 4-3. 棚卸し完了（履歴保存）
- 「棚卸し完了」で、その時点の在庫を `inventory_snapshots` に保存します。
- 保存後に **在庫数を0にリセットする/しない**を選べます。

### 4-4. 棚卸し履歴とゴミ箱
- 履歴は一覧表示、行ごとにCSVダウンロード可能
- 削除は「ゴミ箱へ移動」→ ゴミ箱内でのみ完全削除（delete入力）

### 4-5. 削除（一覧から除外）
在庫一覧の削除は、CSVやマスタを消さずに **その画面の一覧から一時的に非表示**にする動きです（誤削除対策）。

---

## 5. 仕込みカレンダー（Planner）

### 5-1. 役割
仕込み予定（いつ何のレシピを作るか）を保存します。発注リストはこの予定から必要材料を集計します。

---

## 6. 発注リスト（OrderList）

### 6-1. 考え方（最重要）
発注リストは「必要量 − 在庫」で不足/残量を評価し、**残在庫が“1発注単位の2割”を切ったら発注対象**に上げます。

#### 例（本単位のビネガー）
- 材料マスター: `1本 = 750ml`, `lastPrice = (1本の価格)`
- 残在庫 150ml（= 2割）を切ったら発注対象
- 発注量は ml ではなく **1本**単位で切り上げ表示されます

### 6-2. 表の列
- **必要量**: 期間内の予定から集計（g/mlなどに正規化）
- **残在庫**: 在庫 − 必要量（0下限）
- **発注量**
  - 材料マスターがある材料: **元の単位（CSV）**で `1袋/1本`のように表示（切り上げ）
  - 材料マスターが無い材料: 不足分ベース（安全側）で表示

### 6-3. 発注単位（元の単位）の優先順位
発注単位ラベルは次の優先順位で決まります。

1) **元の単位（CSV）上書き（csv_unit_overrides）**
2) **CSVマスタの unit**
3) 最後の保険で `袋`

---

## 7. レシピ入力（材料欄）

### 7-1. 材料名の入力と参照
材料名の入力候補は、**材料マスターを優先**して、CSVも補助として出します。

### 7-2. ml/cc/g の計算
レシピ材料のコスト計算は次の前提です。

- `unit` が `g/ml/cc` の場合:
  - `purchaseCost` は **kg/Lあたりの単価**（正規化済み）
  - `cost = (quantity / 1000) × purchaseCost`
- それ以外（個数単位など）の場合:
  - `cost = quantity × purchaseCost`

---

## 8. 管理者機能（概要）

- ユーザー管理（管理者のみ表示）
- パスワード再設定メール送信（運用上はメール方式を推奨）
- 管理者は全レシピにアクセス可能（RLSで許可）
- レシピの作成者表示（管理者向け）

---

## 9. スマホ利用時の注意（PCかタブレット推奨）

以下の画面はスマホだと操作しづらい/表示が崩れる場合があるため、入った瞬間に注意モーダルを表示します。

- 在庫管理
- 仕込みカレンダー
- データ管理
- ユーザー管理
- 発注リスト

また、スライドメニュー内にも「PCかタブレット推奨」の注意書きを表示します。

---

## 10. デプロイ（GitHub Pages）

- `main` ブランチに push すると、GitHub Actions（`Deploy to GitHub Pages`）が走り自動デプロイされます。
- 公開URLは `package.json` の `homepage` を参照します。

---

## 11. トラブルシューティング（よくある症状）

### 11-1. 在庫数を入れても「更新に失敗しました」
- UI専用フィールドがDB更新に混入すると起きます。現在は `_master` をDB更新から除外しています。

### 11-2. 発注量が桁違いに大きい
- 材料マスターの `lastPrice`（袋の合計価格）を、在庫の単価として直接掛け算すると起きます。  
  現在は `lastPrice / packetSize` に正規化しています。

### 11-3. 画面が古いままに見える / 反映されない
- ブラウザのキャッシュ・開発サーバーの再起動で解消することがあります。
