# レシピ管理アプリ マスター説明書（完全版）

このファイルは **`README.md` / `USER_GUIDE.md` / `OPERATION_MANUAL.md` の内容を統合**し、さらに「今日追加した複雑な連携（在庫×材料マスター×発注×単位）」を含めて、**この1冊だけで運用・管理・開発ができる**ことを目的としたマスター説明書です。

- **対象**: 現場運用者 / 管理者 / 開発者
- **アプリ**: recipe management（React + Vite + Supabase / GitHub Pages）

> 補足: 既存の `README.md` / `USER_GUIDE.md` / `OPERATION_MANUAL.md` は残しますが、運用上は本書を正として参照してください。

---

## 目次

- [1. まず何ができるアプリ？（概要）](#1-まず何ができるアプリ概要)
- [2. ログイン/アカウント（現場・管理者共通）](#2-ログインアカウント現場管理者共通)
- [3. 画面構成と基本操作（レシピ）](#3-画面構成と基本操作レシピ)
- [4. レシピの計算機能（倍率 / Baker's %）](#4-レシピの計算機能倍率--bakers-)
- [5. 原価（仕入れCSV）と自動入力](#5-原価仕入れcsvと自動入力)
- [6. 今日の重要追加：材料マスター×在庫×発注をつなぐ「大原則」](#6-今日の重要追加材料マスター在庫発注をつなぐ大原則)
- [7. 材料マスター管理（内容量・袋単価・元の単位）](#7-材料マスター管理内容量袋単価元の単位)
- [8. 在庫管理（棚卸し）](#8-在庫管理棚卸し)
- [9. 仕込みカレンダー（Planner）](#9-仕込みカレンダープランナー)
- [10. 発注リスト（OrderList）](#10-発注リストorderlist)
- [11. ゴミ箱（レシピ/在庫履歴）と削除ポリシー](#11-ゴミ箱レシピ在庫履歴と削除ポリシー)
- [12. 管理者機能（ユーザー/権限/閲覧範囲）](#12-管理者機能ユーザー権限閲覧範囲)
- [13. スマホ利用時の注意（PCかタブレット推奨）](#13-スマホ利用時の注意pcかタブレット推奨)
- [14. よくあるトラブルと対処](#14-よくあるトラブルと対処)
- [15. 開発者向け（セットアップ/デプロイ/DB）](#15-開発者向けセットアップデプロイdb)
- [16. 付録（関連ファイル一覧）](#16-付録関連ファイル一覧)

---

## 1. まず何ができるアプリ？（概要）

- **レシピ管理**: 登録 / 編集 / 閲覧 / 削除（ゴミ箱あり）  
- **計算**:
  - 通常レシピ: **仕込み倍率**で増減
  - パン（Baker's %）: **狙いの総重量 (g)** を入れると自動再計算
- **原価計算**: 仕入れCSV（仕入れマスタ）＋材料マスターから、レシピの材料費を自動算出
- **在庫管理（棚卸し）**: 在庫入力・棚卸し履歴（CSVダウンロード）・ゴミ箱・完全削除
- **仕込みカレンダー**: いつ何を仕込むかを登録（発注リストの集計元）
- **発注リスト**: 在庫と必要量から、発注対象を自動抽出（2割ルール + 発注単位で切り上げ）
- **翻訳**: レシピの多言語翻訳表示
- **データ管理**: CSVアップロード、バックアップ（JSONの入出力）

---

## 2. ログイン/アカウント（現場・管理者共通）

### 2-1. ログイン方式（現在）

現在は **Supabase Auth（メールアドレス + パスワード）**でログインします。

- **ログイン**: メールアドレス / パスワード
- **新規登録**: メールアドレス / パスワード / **表示ID（displayId）**
- **パスワード再設定**: メールアドレス宛に再設定メールを送信

> 注意: `USER_GUIDE.md` には「秘密の質問」等の記載がありますが、現行UI/実装では使用していません（過去仕様/移行途中の名残です）。

### 2-2. 表示ID（displayId）の重要性

新規登録時に入れる **表示ID** は、既存データ（在庫/棚卸し/レシピ等）の引き継ぎに使います。

- **運用ルール**: 一度決めたら、後から変えないでください

---

## 3. 画面構成と基本操作（レシピ）

### 3-1. 一覧・検索・フィルター

- **検索**: レシピ名、材料、メモなどを横断検索
- **フィルター**:
  - 店舗 / コース / カテゴリー
  - 表示モード（通常 / 全表示）

### 3-2. 並び替え

- **PC**: ドラッグ&ドロップで並び替え
- **スマホ**: 誤操作防止のため、カードを **1秒長押し**でドラッグモード

### 3-3. 削除と復元

- レシピ削除 → **ゴミ箱へ移動**
- ゴミ箱で **復元** または **完全削除**

### 3-4. 共有レシピの安全設計（編集するとコピー）

**自分以外のレシピ**（管理者や他スタッフが作成したレシピ）を編集して保存した場合は、元レシピを壊さないために **自動的に「コピー」が作成**されます。

- **自分のレシピ**: 上書き保存
- **他人のレシピ**: コピーを作って自分のレシピとして保存

### 3-5. 取り込み（Web / 画像）

- **Web取り込み**: URLを貼ると解析してレシピ化（取り込み後の微調整は必要）
- **画像取り込み**: 画像から文字を読み取って入力（手書き/撮影状態によっては修正が必要）

### 3-6. 便利機能

- **最近見たレシピ**: 直近で閲覧したレシピを素早く再表示
- **画像登録**: レシピに完成写真を付けて視覚的に管理
- **タグ/カテゴリ**: 整理と検索性を上げる

---

## 4. レシピの計算機能（倍率 / Baker's %）

### 4-1. 通常レシピ（倍率）

- **×1.0**: 元の分量
- **×2.0**: 2倍
- **×0.5**: 半分

### 4-2. パン（Baker's %）

パン・生地レシピでは **「狙いの総重量 (g)」** を入力すると、ベーカーズ%に従って全材料が再計算されます。

### 4-3. 翻訳

画面右上の言語切替で、AI翻訳表示ができます。

---

## 5. 原価（仕入れCSV）と自動入力

### 5-1. データ管理（CSVアップロード）

- メニューから **データ管理**へ
- **仕入れCSV** をアップロード
  - 材料名 / 単価 / 単位 / 業者 の形式や、業務システムの出力形式に対応

### 5-2. レシピ入力での自動反映

レシピの材料名入力時に、仕入れ情報（価格など）を参照して **原価が自動計算**されます。

### 5-3. バックアップ（JSON）

データ管理画面から、レシピデータのバックアップ（JSON）を **ダウンロード（保存）** / **インポート（復元）**できます。

---

## 6. 今日の重要追加：材料マスター×在庫×発注をつなぐ「大原則」

ここが一番重要です。**在庫・発注のズレ/桁違いは、ほぼ“単価の意味”と“単位の優先順位”の崩れ**で起きます。

### 6-1. 用語

- **仕入れCSV（仕入れマスタ）**: 価格/業者/（あれば）単位
- **材料マスター（材料マスター管理）**: 内容量（`packetSize`/`packetUnit`）と袋単価（`lastPrice`）
- **元の単位（CSV）**: 発注単位（袋/本/箱…）。CSVに無い/不明な場合がある
- **元の単位（CSV）上書き**: ユーザーが編集して保存する「元の単位」

### 6-2. 優先順位（材料名が一致する場合）

1) **材料マスター（unit_conversions）**  
2) **元の単位（CSV）上書き（csv_unit_overrides）**  
3) **CSV（仕入れマスタ）**  
4) 手入力（在庫/レシピ）

### 6-3. 「単価の意味」（桁違い防止の核心）

- **材料マスターの `lastPrice`** は **1袋/1本の合計価格**（パック価格）です  
- 在庫計算（`price × quantity`）に使うには、**内容量で割って単位あたり単価**に直す必要があります

例:
- 25,000g（1袋）が 10,900円 → \(10900 / 25000 = 0.436\) 円/g

---

## 7. 材料マスター管理（内容量・袋単価・元の単位）

### 7-1. 何を登録する画面？

- **内容量**: 1袋/1本あたりの量（g/ml 等）
- **袋単価**: 1袋/1本あたりの価格（合計）

これが、在庫金額・発注切り上げ・2割ルールの基準になります。

### 7-2. 「元の単位（CSV）」を編集できる理由

CSVには発注単位が入っていない/不明なケースがあるため、材料マスター画面で **「元の単位（CSV）」だけ編集**できるようになっています。

- 保存先: `csv_unit_overrides`
- 保存タイミング: 入力して **フォーカスを外したとき（onBlur）**

> 注意: DBに `csv_unit_overrides` テーブルが未作成（マイグレーション未適用）だと保存に失敗します。  
> マイグレーション: `supabase/migrations/20260202160000_create_csv_unit_overrides.sql`

---

## 8. 在庫管理（棚卸し）

### 8-1. 基本

- 在庫は `inventory_items` に保存されます
- 仕入れCSVにある材料は、DB未登録でも **一覧に未登録（phantom）として表示**されます
- ページに入った直後の業者フィルタは **「すべて」** です
- 「業者名」列は **クリックでソート**できます（在庫の見比べをしやすくするため）

### 8-2. 材料マスターがある材料の扱い（重要）

材料名が材料マスターにある場合、在庫画面では次を優先します。

- **単価**: `lastPrice / packetSize` に正規化（在庫金額が壊れない）
- **内容量表示**: `packetSize + packetUnit` を「内容量」列に表示
- **単位の正規化（本→ml 等）**
  - 在庫が「本/袋/個」などの個数単位で、材料マスターが g/ml の量を持つ場合
  - 在庫単位を master の単位に合わせ、在庫数も内容量で換算します

### 8-3. 棚卸し完了（履歴保存）

- 「棚卸し完了」で、その時点の在庫を `inventory_snapshots` に保存します
- 保存後、**在庫数を0にリセットする/しない**の選択ができます

### 8-4. 棚卸し履歴

- 履歴一覧を表示
- **各行にCSVダウンロード**ボタン（明細出力）
- 削除は「ゴミ箱へ移動」→ ゴミ箱内でのみ完全削除

### 8-6. 数量入力のUI（現場の入力ミス対策）

- 数量入力は、誤タップを減らすために **スピナー（▲▼）を表示しない**設計です
- 数量欄をクリックしたとき、編集しやすいように **カーソルが末尾に来る**挙動にしています

### 8-5. 一覧からの削除（非表示）

在庫一覧の削除は、CSVやマスターを消さずに **その一覧から一時的に非表示**にする運用です（誤削除対策）。

---

## 9. 仕込みカレンダー（プランナー）

仕込み予定（いつ何のレシピを作るか）を保存する画面です。発注リストはこの予定から必要材料を集計します。

---

## 10. 発注リスト（OrderList）

### 10-1. 発注対象に上がる条件（2割ルール）

発注リストは、在庫と必要量から「残在庫」を求め、**残在庫が“1発注単位の2割”を切ったら発注対象**に上げます。

例（ビネガー）:
- 1本=750ml
- 2割=150ml を切ったら発注対象
- 発注量は ml ではなく **1本**として表示（切り上げ）

### 10-2. 表示の考え方

- **必要量**: 仕込み予定から集計（g/ml に正規化）
- **残在庫**: `max(0, 在庫 − 必要量)`
- **発注量**:
  - 材料マスターがある → **元の単位（CSV）**で切り上げ（袋/本…）
  - 材料マスターがない → 不足分ベース（安全側）

### 10-3. 発注単位（元の単位）の優先順位

1) 元の単位（CSV）上書き（`csv_unit_overrides`）
2) CSVの unit
3) 最後の保険（例: `袋`）

---

## 11. ゴミ箱（レシピ/在庫履歴）と削除ポリシー

### 11-1. 基本方針

誤削除を避けるため、削除は基本的に **「ゴミ箱へ移動」→「ゴミ箱内で完全削除」**の2段階です。

### 11-2. 完全削除の安全確認

完全削除は、入力確認（例: `delete`）など **意図確認を必須**にして、事故を防ぎます。

---

## 12. 管理者機能（ユーザー/権限/閲覧範囲）

- **ユーザー管理**（管理者のみ）
- **パスワード再設定**: 管理者は運用上、**再設定メール送信**で対応
- **管理者は全レシピにアクセス可能**
- 管理者向けに、レシピ一覧/詳細で **作成者ID** を表示

---

## 13. スマホ利用時の注意（PCかタブレット推奨）

以下の画面はスマホだと操作しづらい/表示が崩れる可能性があるため、入った瞬間に注意モーダルを表示します（同一セッション内は繰り返し表示しない）。

- 在庫管理
- 仕込みカレンダー
- データ管理
- ユーザー管理
- 発注リスト

また、スライドメニュー内にも「PCかタブレット推奨」の注意書きを表示します。

### 13-1. スライドメニュー（スマホ）

- **ログイン中ユーザー（メール/表示ID）** をメニュー上部に表示します
- 閉じるボタン（`✕`）は **1つだけ**にして、誤操作を減らします

---

## 14. よくあるトラブルと対処

### 14-1. 画面が「Loading...」で止まる

- 通信/認証状態の取得に失敗している可能性があります
- まずは **再読み込み（リロード）** を実施

### 14-2. 在庫数更新が失敗する

- UI専用フィールド（例: `_master`）がDB更新に混入すると失敗します  
  → 現在はDB更新時に除外する実装になっています

### 14-3. 在庫金額や発注量が桁違い

- `lastPrice`（袋の合計価格）を、単位あたり単価として扱うと桁が壊れます  
  → `lastPrice / packetSize` の正規化が必要です（本書6章）

### 14-4. 「元の単位（CSV）」を保存できない

- `csv_unit_overrides` テーブル未作成（マイグレーション未適用）の可能性  
  → `supabase/migrations/20260202160000_create_csv_unit_overrides.sql` を適用してください

---

## 15. 開発者向け（セットアップ/デプロイ/DB）

### 15-1. 技術スタック

- **Frontend**: React, Vite
- **DB/Backend/Auth**: Supabase
- **Drag & Drop**: @dnd-kit
- **Deployment**: GitHub Pages（`gh-pages`）

### 15-2. ローカル起動

```bash
npm install
npm run dev
```

### 15-3. ビルド & デプロイ

```bash
npm run build
npm run deploy
```

### 15-4. Supabase（DBとRLS）

- `supabase/migrations/` にマイグレーションが入っています
- 主要テーブル例:
  - `profiles`（表示ID/roleなど）
  - `recipes` / `deleted_recipes`（レシピとゴミ箱）
  - `unit_conversions`（材料マスター）
  - `inventory_items` / `inventory_snapshots` / `deleted_inventory_snapshots`（在庫と棚卸し履歴）
  - `csv_unit_overrides`（元の単位上書き）

---

## 16. 付録（関連ファイル一覧）

### 16-1. 主要ドキュメント

- `docs/MASTER_MANUAL.md`（本書）
- `README.md`（概要・開発の入口）
- `docs/USER_GUIDE.md`（ユーザー向け簡易ガイド ※一部過去仕様あり）
- `docs/OPERATION_MANUAL.md`（運用ルール中心の説明）

### 16-2. 補助ページ

- ルヴァン種ガイドはアプリ内「ルヴァンガイド」画面（`src/components/LevainGuide.jsx`）に統合されています

### 16-3. 注意（別用途のHTML）

`public/Instructions.html` / `public/flaro.html` は、別システム（フラロ勤怠）のQ&Aドキュメントで、本アプリの運用説明とは別物です。
