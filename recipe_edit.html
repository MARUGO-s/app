<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>レシピ編集 — Recipe Box</title>
  <link rel="stylesheet" href="assets/css/style.css">
</head>
<body>

  <header class="app-header">
    <h1 class="brand">レシピ編集</h1>
    <div class="header-actions">
      <a href="index.html" class="btn ghost">ホーム</a>
      <button class="btn primary js-save">保存する</button>
    </div>
  </header>

  <main class="container">
    <form id="editForm" class="panel">
      
      <div class="field" style="background: #f8f9fa; padding: 1.5rem; border-radius: var(--radius-base); margin-bottom: 2rem;">
        <label for="recipeUrl" style="font-size: 1rem;">URLから自動入力</label>
        <div style="display: flex; align-items: center; gap: 0.75rem; margin-top: 0.75rem;">
          <input id="recipeUrl" class="input" placeholder="レシピページのURLを貼り付け" style="flex-grow: 1; min-width: 0;">
          <button type="button" class="btn primary" id="importFromUrlBtn" style="white-space: nowrap;">インポート</button>
        </div>
        <div id="importStatus" style="margin-top: 0.75rem; font-size: 0.875rem;"></div>
      </div>
      <div class="field">
        <label for="title">料理名</label>
        <input id="title" name="title" class="input" required />
      </div>
      <div class="field">
        <label for="category">カテゴリー</label>
        <select id="category" name="category" class="input">
          <option value="アミューズ">アミューズ</option>
          <option value="前菜">前菜</option>
          <option value="温菜">温菜</option>
          <option value="メイン" selected>メイン</option>
          <option value="デザート">デザート</option>
        </select>
      </div>
      <div class="field">
        <label for="tags">タグ (カンマ区切り)</label>
        <input id="tags" name="tags" class="input" placeholder="フレンチ, 定番, etc." />
      </div>
      <div class="field">
        <label for="notes">メモ・コツ</label>
        <textarea id="notes" name="notes" class="input" rows="3"></textarea>
      </div>
       <div class="field">
        <label>材料</label>
        <div id="ingredientsEditor"></div>
        <div style="margin-top: 1rem; display: flex; gap: 0.75rem;">
            <button type="button" class="btn ghost small" id="addIng">＋ 材料を追加</button>
            <button type="button" class="btn primary small" id="ai-wizard-btn">✨ AIで創作</button>
        </div>
      </div>
      <div class="field">
        <label>作り方</label>
        <div id="stepsEditor"></div>
        <button type="button" class="btn ghost small" id="addStep" style="margin-top: 1rem;">＋ 手順を追加</button>
      </div>
    </form>
  </main>
  
  <div id="ai-modal" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">✨ AI ルセット創作アシスタント</h2>
        <button id="modal-close-btn" class="modal-close">&times;</button>
      </div>
      <div id="modal-body" class="modal-body">
        <div id="ai-step-1">
          <p class="step-title">1. 料理のジャンルを選択</p>
          <div class="genre-selection">
            <button class="genre-btn" data-genre="フレンチ">フレンチ</button>
            <button class="genre-btn" data-genre="イタリアン">イタリアン</button>
            <button class="genre-btn" data-genre="和食">和食</button>
            <button class="genre-btn" data-genre="中華">中華</button>
            <button class="genre-btn" data-genre="創作料理">創作料理</button>
            <button class="genre-btn" data-genre="デザート">デザート</button>
            <button class="genre-btn" data-genre="パン">パン</button>
          </div>
          <div class="field">
            <label for="ai-custom-request" style="font-size: 0.8em; margin-bottom: 0.5rem;">追加の希望 (任意)</label>
            <textarea id="ai-custom-request" class="input" rows="2" placeholder="例: 子供向けの味付け, 野菜を多めに"></textarea>
          </div>
          <div class="modal-footer">
            <button id="get-suggestions-btn" class="btn primary" disabled>メニュー案を創作</button>
          </div>
        </div>
        <div id="ai-step-2" style="display: none;">
          <p class="step-title">2. メニューを選択</p>
          <div id="menu-suggestions" class="menu-suggestions"></div>
          <div class="modal-footer">
            <button id="generate-full-recipe-btn" class="btn primary" disabled>このメニューでルセットを生成</button>
          </div>
        </div>
        <div id="ai-step-3" style="display: none;">
            <p class="step-title">3. 内容を確認して反映</p>
            <div id="recipe-preview" style="white-space: pre-wrap; background: #f8f9fa; padding: 1rem; border-radius: 0.5rem; max-height: 40vh; overflow-y: auto; border: 1px solid var(--line-soft);"></div>
            <div class="modal-footer">
              <button id="apply-recipe-btn" class="btn primary">フォームに反映する</button>
            </div>
        </div>
        <div id="ai-loading" style="display: none;">
          <div class="loading-spinner"></div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="assets/js/app-edit.js"></script>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      'use strict';
      // Supabaseクライアントはapp-edit.jsで読み込み済みのものを利用
      if (typeof supabase === 'undefined') return;
      const sb = supabase.createClient("https://ctxyawinblwcbkovfsyj.supabase.co", "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN0eHlhd2luYmx3Y2Jrb3Zmc3lqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ5NzE3MzIsImV4cCI6MjA3MDU0NzczMn0.HMMoDl_LPz8uICruD_tzn75eUpU7rp3RZx_N8CEfO1Q");

      const urlInput = document.getElementById('recipeUrl');
      const importBtn = document.getElementById('importFromUrlBtn');
      const statusEl = document.getElementById('importStatus');
      const titleEl = document.getElementById('title');
      const notesEl = document.getElementById('notes');
      const ingredientsEditor = document.getElementById('ingredientsEditor');
      const stepsEditor = document.getElementById('stepsEditor');
      const addIngBtn = document.getElementById('addIng');
      const addStepBtn = document.getElementById('addStep');

      const escapeHtml = (s) => (s ?? "").toString().replace(/[&<>\"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m]));
      const addIngredientRow = (data = {}) => {
        const div = document.createElement('div');
        div.className = 'ingredient-row';
        div.innerHTML = `<input type="text" placeholder="材料名 *" value="${escapeHtml(data.item||'')}" data-field="item" class="ing-item"><input type="text" placeholder="分量" value="${escapeHtml(data.quantity||'')}" data-field="quantity" class="ing-qty"><input type="text" placeholder="単位" value="${escapeHtml(data.unit||'')}" data-field="unit" class="ing-unit"><button type="button" class="btn danger small js-remove-row">削除</button>`;
        ingredientsEditor.appendChild(div);
      };
      const addStepRow = (data = {}) => {
          const div = document.createElement('div');
          div.className = 'step-row';
          div.innerHTML = `<input type="text" placeholder="手順 *" value="${escapeHtml(data.instruction||'')}" data-field="instruction"><button type="button" class="btn danger small js-remove-row">削除</button>`;
          stepsEditor.appendChild(div);
      };

      importBtn.addEventListener('click', async () => {
        const u = (urlInput?.value || '').trim(); if (!u) { urlInput?.focus(); return; }
        await runImport(u);
      });

      async function runImport(url) {
        try {
          setStatus('レシピを読み取り中…');
          const { data, error } = await sb.functions.invoke('extract-recipe', { body: { url } });
          if (error) throw error;
          if (!data?.ok) throw new Error(data?.message || 'import failed');

          const r = data.data || {};
          if (titleEl) titleEl.value = r.title || '';
          if (notesEl) notesEl.value = r.description || '';
          
          if (ingredientsEditor) ingredientsEditor.innerHTML = '';
          (r.ingredientLines || []).forEach(line => {
             addIngredientRow({ item: line });
          });

          if (stepsEditor) stepsEditor.innerHTML = '';
          (r.steps || []).forEach(text => {
            addStepRow({ instruction: text });
          });

          setStatus('読み取り完了しました。');
        } catch (e) {
          console.error(e);
          setStatus('読み取り失敗: ' + (e.message || e));
          alert('読み取りに失敗しました: ' + (e.message || e));
        }
      }
      function setStatus(msg){ if (statusEl){ statusEl.textContent = msg; } }
    });
  </script>
  </body>
</html>
