<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>レシピ編集 — Recipe Box</title>
  <link rel="stylesheet" href="assets/css/style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    .image-upload-section {
      border: 2px dashed #ddd;
      border-radius: 8px;
      padding: 30px;
      text-align: center;
      margin: 20px 0;
      background: #f9f9f9;
      transition: border-color 0.3s ease, background-color 0.3s ease;
    }
    .image-upload-section.dragover {
      border-color: #007bff;
      background: #f0f8ff;
    }
    .image-preview {
      max-width: 100%;
      max-height: 300px;
      border-radius: 8px;
      margin: 10px 0;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .loading-message {
      color: #007bff;
      font-style: italic;
      margin: 10px 0;
    }
    .error-message {
      color: #dc3545;
      background: #f8d7da;
      padding: 10px;
      border-radius: 5px;
      margin: 10px 0;
    }
    .success-message {
      color: #155724;
      background: #d4edda;
      padding: 10px;
      border-radius: 5px;
      margin: 10px 0;
    }
    
    /* 画像解析メッセージスタイル */
    .error-message {
      background-color: #fee;
      color: #c33;
      border: 1px solid #fcc;
      padding: 10px;
      border-radius: 5px;
      margin: 10px 0;
    }
    
    .success-message {
      background-color: #efe;
      color: #363;
      border: 1px solid #cfc;
      padding: 10px;
      border-radius: 5px;
      margin: 10px 0;
    }
    
    .loading-message {
      background-color: #eef;
      color: #336;
      border: 1px solid #ccf;
      padding: 10px;
      border-radius: 5px;
      margin: 10px 0;
    }
    
    /* 画像プレビュースタイル */
    .image-preview {
      max-width: 100%;
      max-height: 300px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    /* アップロードエリアスタイル */
    .image-upload-section {
      text-align: center;
      padding: 2rem;
      border: 2px dashed #ccc;
      border-radius: 8px;
      background-color: #f9f9f9;
    }
    
    .image-upload-section:hover {
      border-color: #999;
      background-color: #f5f5f5;
    }
  </style>
</head>
<body>

  <header class="app-header">
    <h1 class="brand">レシピ編集</h1>
    <div class="header-actions">
      <a href="index.html" class="btn ghost">ホーム</a>
      <button class="btn primary js-save">保存する</button>
    </div>
  </header>

  <main class="container">
    <form id="editForm" class="panel">
      
      <div class="field">
        <label for="title">料理名</label>
        <div style="display: flex; gap: 0.5rem; align-items: center;">
          <input id="title" name="title" class="input" required style="flex: 1;" />
          <button type="button" class="btn ghost small" id="urlImportBtn" title="URLからレシピを読み込み">
            <i class="fas fa-link"></i> URL読み込み
          </button>
          <button type="button" class="btn ghost small" id="imageImportBtn" title="画像からレシピを抽出" onclick="console.log('📷 画像解析ボタンがクリックされました！'); document.getElementById('image-import-modal').style.display='flex';">
            <i class="fas fa-camera"></i> 画像解析
          </button>
        </div>
      </div>
      <div class="field category-tags-field">
        <div class="category-tags-row">
          <div class="category-section">
            <div class="category-input-wrapper">
              <button type="button" id="categorySelectBtn" class="input category-select-btn">
                <span id="selectedCategoryText">カテゴリーを選択</span>
                <i class="fas fa-chevron-down"></i>
              </button>
            </div>
            <div id="customCategories" class="custom-categories"></div>
          </div>
          <div class="tags-section">
            <button type="button" id="tagSelectBtn" class="input tag-select-btn">
              <span id="selectedTagsText">タグを選択</span>
              <i class="fas fa-chevron-down"></i>
            </button>
          </div>
        </div>
      </div>
      <div class="field servings-field">
        <label for="servings">出来上がり人数</label>
        <div class="servings-input-wrapper">
          <input id="servings" name="servings" class="input" type="number" min="1" max="20" placeholder="例: 4" />
          <span class="servings-unit">人前</span>
        </div>
        <div class="servings-actions">
          <button type="button" class="btn ghost small" id="adjustServingsBtn">人数に応じて材料量を調整</button>
        </div>
      </div>
      <div class="field notes-field">
        <label for="notes">メモ・コツ</label>
        <textarea id="notes" name="notes" class="input" rows="3"></textarea>
      </div>
       <div class="field">
        <label>材料</label>
        <div id="ingredientsEditor"></div>
        <div style="margin-top: 1rem; display: flex; gap: 0.75rem;">
            <button type="button" class="btn ghost small" id="addIng">＋ 材料を追加</button>
            <button type="button" class="btn primary small" id="ai-wizard-btn">✨ AIで創作</button>
        </div>
      </div>
      <div class="field">
        <label>作り方</label>
        <div id="stepsEditor"></div>
        <button type="button" class="btn ghost small" id="addStep" style="margin-top: 1rem;">＋ 手順を追加</button>
      </div>
    </form>
  </main>
  
  <!-- URL読み込みモーダル -->
  <div id="url-import-modal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">URLからレシピを読み込み</h2>
        <button id="url-import-modal-close-btn" class="modal-close">&times;</button>
      </div>
      <div class="modal-body">
        <div class="field">
          <label for="urlInput">レシピサイトのURL</label>
          <input id="urlInput" type="url" class="input" placeholder="https://example.com/recipe/..." />
        </div>
        <div class="field">
          <label>対応サイト</label>
          <div class="supported-sites">
            <p>以下のサイトからレシピを読み込めます：</p>
            <ul>
              <li>クックパッド</li>
              <li>楽天レシピ</li>
              <li>みんなのきょうの料理</li>
              <li>その他のレシピサイト</li>
            </ul>
          </div>
        </div>
        <div class="field">
          <label>代替手段</label>
          <div class="alternative-method">
            <p>URL読み込みが失敗した場合は、以下の方法をお試しください：</p>
            <button type="button" class="btn ghost small" id="manualInputBtn">
              <i class="fas fa-edit"></i> 手動入力モード
            </button>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button id="urlImportCancelBtn" class="btn ghost">キャンセル</button>
        <button id="urlImportConfirmBtn" class="btn primary">読み込み開始</button>
      </div>
    </div>
  </div>

  <!-- 画像解析モーダル -->
  <div id="image-import-modal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">画像からレシピを抽出</h2>
        <button id="image-import-modal-close-btn" class="modal-close" onclick="document.getElementById('image-import-modal').style.display='none';">&times;</button>
      </div>
      <div class="modal-body">
        <div class="image-upload-section" id="uploadArea">
          <i class="fas fa-cloud-upload-alt" style="font-size: 3rem; color: #666; margin-bottom: 1rem;"></i>
          <p>レシピ画像をアップロードしてください</p>
          <div style="display: flex; gap: 1rem; justify-content: center; margin-top: 1rem;">
            <button type="button" id="fileSelectBtn" class="btn primary" onclick="document.getElementById('imageInput').click();">
              <i class="fas fa-folder-open"></i> ファイルから選択
            </button>
            <button type="button" id="cameraBtn" class="btn secondary" onclick="document.getElementById('cameraInput').click();">
              <i class="fas fa-camera"></i> カメラで撮影
            </button>
          </div>
          <input type="file" id="imageInput" accept="image/*" style="display: none;">
          <input type="file" id="cameraInput" accept="image/*" capture="environment" style="display: none;">
        </div>
        
        <div id="previewArea" style="display: none; text-align: center; margin-top: 1rem;">
          <img id="previewImage" class="image-preview" alt="プレビュー" style="max-width: 100%; max-height: 300px; border-radius: 8px;">
          <div style="margin-top: 1rem;">
            <button type="button" id="analyzeButton" class="btn primary" onclick="analyzeImage();">
              <i class="fas fa-search"></i> 画像を解析してレシピを抽出
            </button>
            <button type="button" id="clearImageButton" class="btn ghost" onclick="clearImage();">
              <i class="fas fa-trash"></i> クリア
            </button>
          </div>
        </div>
        
        <div id="imageMessageArea" style="margin-top: 1rem;"></div>
      </div>
      <div class="modal-footer">
        <button id="imageImportCancelBtn" class="btn ghost" onclick="document.getElementById('image-import-modal').style.display='none';">閉じる</button>
      </div>
    </div>
  </div>
  
  <!-- カテゴリー選択モーダル -->
  <div id="category-modal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">カテゴリーを選択</h2>
        <button id="category-modal-close-btn" class="modal-close">&times;</button>
      </div>
      <div class="modal-body">
        <div class="category-list">
          <div class="category-group">
            <h3 class="category-group-title">基本カテゴリー</h3>
            <div class="category-options" id="category-options">
              <!-- データベースから動的に読み込み -->
            </div>
          </div>
          <div class="category-group" id="custom-category-group" style="display: none;">
            <h3 class="category-group-title">カスタムカテゴリー</h3>
            <div class="category-options" id="custom-category-options">
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button id="add-new-category-btn" class="btn ghost">
            <i class="fas fa-plus"></i>
            新しいカテゴリーを追加
          </button>
          <div class="modal-footer-actions">
            <button id="category-ok-btn" class="btn primary">OK</button>
            <button id="category-cancel-btn" class="btn ghost">キャンセル</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- タグ選択モーダル -->
  <div id="tag-modal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">タグを選択</h2>
        <button id="tag-modal-close-btn" class="modal-close">&times;</button>
      </div>
      <div class="modal-body">
        <div class="tag-list">
          <div class="tag-group">
            <h3 class="tag-group-title">利用可能なタグ</h3>
            <div class="tag-options" id="tag-options">
              <!-- データベースから動的に読み込み -->
            </div>
          </div>
          <div class="tag-group" id="custom-tag-group" style="display: none;">
            <h3 class="tag-group-title">カスタムタグ</h3>
            <div class="tag-options" id="custom-tag-options">
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button id="add-new-tag-btn" class="btn ghost">
            <i class="fas fa-plus"></i>
            新しいタグを追加
          </button>
          <div class="modal-footer-actions">
            <button id="tag-ok-btn" class="btn primary">OK</button>
            <button id="tag-cancel-btn" class="btn ghost">キャンセル</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="ai-modal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">✨ AI ルセット創作アシスタント</h2>
        <button id="modal-close-btn" class="modal-close">&times;</button>
      </div>
      <div id="modal-body" class="modal-body">
        <div id="ai-step-1" style="display: block;">
          <p class="step-title">1. 料理のジャンルを選択</p>
          <div class="genre-selection">
            <button class="genre-btn" data-genre="フレンチ">フレンチ</button>
            <button class="genre-btn" data-genre="イタリアン">イタリアン</button>
            <button class="genre-btn" data-genre="和食">和食</button>
            <button class="genre-btn" data-genre="中華">中華</button>
            <button class="genre-btn" data-genre="創作料理">創作料理</button>
            <button class="genre-btn" data-genre="デザート">デザート</button>
            <button class="genre-btn" data-genre="パン">パン</button>
          </div>
          <div class="field">
            <label for="ai-custom-request" style="font-size: 0.8em; margin-bottom: 0.5rem;">追加の希望 (任意)</label>
            <textarea id="ai-custom-request" class="input" rows="2" placeholder="例: 子供向けの味付け, 野菜を多めに"></textarea>
          </div>
          <div class="modal-footer">
            <button id="get-suggestions-btn" class="btn primary" disabled>メニュー案を創作</button>
          </div>
        </div>
        <div id="ai-step-2" style="display: none;">
          <p class="step-title">2. メニューを選択</p>
          <div id="menu-suggestions" class="menu-suggestions"></div>
          <div class="modal-footer">
            <button id="generate-full-recipe-btn" class="btn primary" disabled>このメニューでルセットを生成</button>
          </div>
        </div>
        <div id="ai-step-3" style="display: none;">
            <p class="step-title">3. 内容を確認して反映</p>
            <div id="recipe-preview" style="white-space: pre-wrap; background: var(--bg-secondary); padding: 1rem; border-radius: 0.5rem; max-height: 40vh; overflow-y: auto; border: 1px solid var(--border-medium); color: var(--text-primary); font-size: var(--font-size-sm); line-height: 1.5;"></div>
            <div class="modal-footer">
              <button id="apply-recipe-btn" class="btn primary">フォームに反映する</button>
            </div>
        </div>
        <div id="ai-loading" style="display: none;">
          <div class="loading-spinner"></div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="config.js"></script>
  <script src="assets/js/app-edit.js" defer></script>

  <script>
  // グローバル変数
  let currentFile = null;
  const GEMINI_API_KEY = 'AIzaSyAUsJcsyFY1vcBlrDNn1DYLRor_oqLErx4';
  
  // 画像ファイル処理
  function handleFileSelect(event) {
    const file = event.target.files[0];
    if (file) {
      handleFile(file);
    }
  }
  
  function handleFile(file) {
    console.log('📁 ファイル処理開始:', file.name);
    
    if (!file.type.startsWith('image/')) {
      showImageMessage('画像ファイルを選択してください', 'error');
      return;
    }

    currentFile = file;
    
    // プレビュー表示
    const reader = new FileReader();
    reader.onload = (e) => {
      const previewImage = document.getElementById('previewImage');
      const previewArea = document.getElementById('previewArea');
      
      previewImage.src = e.target.result;
      previewArea.style.display = 'block';
      
      console.log('✅ プレビュー表示完了');
      showImageMessage(`画像読み込み完了: ${file.name}`, 'success');
    };
    reader.readAsDataURL(file);
  }
  
  // 画像解析機能
  async function analyzeImage() {
    if (!currentFile) {
      showImageMessage('画像を選択してください', 'error');
      return;
    }

    console.log('🚀 画像解析開始');
    showImageMessage('画像を解析中...', 'loading');

    try {
      // Base64変換
      const base64 = await fileToBase64(currentFile);
      const base64Data = base64.split(',')[1];
      
      console.log('📤 Gemini Vision API 呼び出し');
      
      // Gemini Vision APIを使用してOCRテキストを抽出
      const ocrPrompt = `以下の画像からレシピのテキストを抽出してください。材料、分量、手順を正確に読み取ってください。`;
      
      const ocrResponse = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-pro:generateContent?key=${GEMINI_API_KEY}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          contents: [{
            parts: [
              { text: ocrPrompt },
              { inline_data: { mime_type: currentFile.type, data: base64Data } }
            ]
          }]
        })
      });
      
      if (!ocrResponse.ok) {
        throw new Error('OCR処理に失敗しました');
      }
      
      const ocrResult = await ocrResponse.json();
      if (!ocrResult.candidates || !ocrResult.candidates[0] || !ocrResult.candidates[0].content) {
        throw new Error('OCR結果を取得できませんでした');
      }
      
      const extractedText = ocrResult.candidates[0].content.parts[0].text;
      console.log('✅ OCRテキスト抽出成功:', extractedText.substring(0, 200) + '...');
      
      // 抽出したテキストを構造化
      if (extractedText) {
        console.log('🤖 レシピ構造化中...');
        
        const prompt = `以下はOCRで抽出したレシピのテキストです。これを次の厳密なJSONスキーマで日本語の値として構造化してください。

スキーマ:
{
  "title": "料理名",
  "description": "レシピの説明", 
  "servings": "人数（数字のみ）",
  "ingredients": [
    { "item": "材料名", "quantity": "分量", "unit": "単位" }
  ],
  "steps": ["手順1", "手順2"],
  "notes": "メモやコツ"
}

要件:
- 値は日本語で記述
- 単位と分量を分離
- 有効なJSONのみを出力（前後に説明文を付けない）

OCRテキスト:
` + extractedText;

        const structureResponse = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-pro:generateContent?key=${GEMINI_API_KEY}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            contents: [{
              parts: [{
                text: prompt
              }]
            }]
          })
        });
        
        if (!structureResponse.ok) {
          console.log('❌ レシピ構造化エラー');
          recipeData = parseTextToRecipe(extractedText);
        } else {
          const structureResult = await structureResponse.json();
          console.log('✅ レシピ構造化成功:', structureResult);
          
          let generatedText = '';
          if (structureResult.candidates && structureResult.candidates[0] && structureResult.candidates[0].content) {
            generatedText = structureResult.candidates[0].content.parts[0].text;
          
          // JSONとしてパース
          try {
            // JSONのクリーンアップ（前後の不要なテキストを除去）
            let cleanJson = generatedText.trim();
            const jsonStart = cleanJson.indexOf('{');
            const jsonEnd = cleanJson.lastIndexOf('}') + 1;
            
            if (jsonStart >= 0 && jsonEnd > jsonStart) {
              cleanJson = cleanJson.substring(jsonStart, jsonEnd);
            }
            
            console.log('🧹 クリーンアップ済みJSON:', cleanJson);
            recipeData = JSON.parse(cleanJson);
            
            // データの妥当性チェック
            if (!recipeData.title && !recipeData.ingredients && !recipeData.steps) {
              throw new Error('有効なレシピデータが含まれていません');
            }
            
          } catch (e) {
            console.log('❌ JSON解析失敗、テキスト解析にフォールバック:', e.message);
            recipeData = parseTextToRecipe(extractedText);
          }
        }
      }
      
      let recipeData = null;
      
      
      console.log('📄 最終レシピデータ:', recipeData);

      // 既存の applyRecipeData 関数を使用してフォームに反映
      if (recipeData) {
        await applyRecipeData(recipeData);
        showImageMessage('画像解析が完了しました！', 'success');
        
        // モーダルを閉じる
        document.getElementById('image-import-modal').style.display = 'none';
      } else {
        showImageMessage('レシピデータの抽出に失敗しました', 'error');
      }
      
    } catch (error) {
      console.error('❌ 解析エラー:', error);
      showImageMessage('画像解析に失敗しました: ' + error.message, 'error');
    }
  }
  
  function parseTextToRecipe(text) {
    // OCRテキストからレシピ情報を抽出
    const lines = text.split('\n').filter(line => line.trim());
    
    // タイトルを探す（最初の行または料理名らしい行）
    let title = 'OCRで抽出したレシピ';
    const titleCandidates = lines.filter(line => 
      !line.includes('材料') && 
      !line.includes('作り方') && 
      !line.includes('手順') &&
      line.length > 2 && line.length < 30
    );
    if (titleCandidates.length > 0) {
      title = titleCandidates[0];
    }
    
    // 材料部分を抽出
    const ingredients = [];
    const ingredientStartIndex = lines.findIndex(line => 
      line.includes('材料') || line.includes('ingredient')
    );
    
    if (ingredientStartIndex >= 0) {
      const stepsStartIndex = lines.findIndex(line => 
        line.includes('作り方') || line.includes('手順') || line.includes('step')
      );
      
      const endIndex = stepsStartIndex >= 0 ? stepsStartIndex : Math.min(ingredientStartIndex + 10, lines.length);
      
      for (let i = ingredientStartIndex + 1; i < endIndex; i++) {
        const line = lines[i].trim();
        if (line && line.length > 1) {
          ingredients.push({ item: line, quantity: '', unit: '' });
        }
      }
    }
    
    // 手順部分を抽出
    const steps = [];
    const stepsStartIndex = lines.findIndex(line => 
      line.includes('作り方') || line.includes('手順') || line.includes('step')
    );
    
    if (stepsStartIndex >= 0) {
      for (let i = stepsStartIndex + 1; i < lines.length; i++) {
        const line = lines[i].trim();
        if (line && line.length > 2) {
          steps.push(line);
        }
      }
    }
    
    // 人数を推測
    let servings = 2;
    const servingLine = lines.find(line => 
      line.includes('人分') || line.includes('人前') || line.match(/\d+人/)
    );
    if (servingLine) {
      const match = servingLine.match(/(\d+)/);
      if (match) servings = parseInt(match[1]);
    }
    
    return {
      title: title,
      description: `OCRで抽出されたレシピです。\n\n${text.substring(0, 150)}...`,
      servings: servings,
      ingredients: ingredients.length > 0 ? ingredients : [{ item: '材料情報が見つかりませんでした', quantity: '', unit: '' }],
      steps: steps.length > 0 ? steps : ['手順情報が見つかりませんでした']
    };
  }
  
  function clearImage() {
    currentFile = null;
    const previewArea = document.getElementById('previewArea');
    const imageInput = document.getElementById('imageInput');
    const cameraInput = document.getElementById('cameraInput');
    const messageArea = document.getElementById('imageMessageArea');
    
    if (previewArea) previewArea.style.display = 'none';
    if (imageInput) imageInput.value = '';
    if (cameraInput) cameraInput.value = '';
    if (messageArea) messageArea.innerHTML = '';
    
    console.log('🗑️ 画像クリア完了');
  }
  
  function showImageMessage(message, type = 'info') {
    const messageArea = document.getElementById('imageMessageArea');
    if (!messageArea) return;
    
    const className = type === 'error' ? 'error-message' : 
                    type === 'success' ? 'success-message' : 'loading-message';
    
    messageArea.innerHTML = `<div class="${className}">${message}</div>`;
    
    if (type === 'success') {
      setTimeout(() => {
        messageArea.innerHTML = '';
      }, 3000);
    }
  }
  
  function fileToBase64(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => resolve(reader.result);
      reader.onerror = reject;
      reader.readAsDataURL(file);
    });
  }
  
  // ファイル選択のイベントリスナー
  document.addEventListener('DOMContentLoaded', function() {
    const imageInput = document.getElementById('imageInput');
    const cameraInput = document.getElementById('cameraInput');
    
    if (imageInput) {
      imageInput.addEventListener('change', handleFileSelect);
    }
    if (cameraInput) {
      cameraInput.addEventListener('change', handleFileSelect);
    }
    
    console.log('✅ 画像解析機能の初期化完了');
  });

  // 画像解析機能を独立して実行
  document.addEventListener('DOMContentLoaded', function() {
    'use strict';
    
    console.log('🚀 画像解析機能を初期化中...');
    
    // Gemini API設定
    const GEMINI_API_KEY = 'AIzaSyAUsJcsyFY1vcBlrDNn1DYLRor_oqLErx4';
    
    const PROJECT_URL = 'https://ctxyawinblwcbkovfsyj.supabase.co';
    const ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN0eHlhd2luYmx3Y2Jrb3Zmc3lqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ5NzE3MzIsImV4cCI6MjA3MDU0NzczMn0.HMMoDl_LPz8uICruD_tzn75eUpU7rp3RZx_N8CEfO1Q';

    if (typeof supabase === 'undefined') {
      console.error('❌ Supabaseが読み込まれていません');
      return;
    }
    const sb = supabase.createClient(PROJECT_URL, ANON);

    const actions = document.querySelector('.header-actions');
    if (actions) {
        const headerBtn = document.createElement('button');
        headerBtn.className = 'btn ghost';
        headerBtn.textContent = 'URLから取り込み';
        actions.insertBefore(headerBtn, actions.firstChild);
        headerBtn.addEventListener('click', async () => {
            const u = prompt('レシピ掲載ページのURL'); if (!u) return;
            await runImport(u);
        });
    }

    async function runImport(url) {
        try {
            alert('Geminiで読み取り中…');
            // 直接Gemini APIを使用してレシピ抽出
            const html = await fetchHTMLViaProxy(url);
            const recipeData = await callGeminiAPI(html, url);
            const r = recipeData || {};
            const titleEl = document.getElementById('title');
            if (titleEl) titleEl.value = r.title || '';
            const notesEl = document.getElementById('notes');
            if (notesEl) notesEl.value = r.description || '';
            const ingredientsEditor = document.getElementById('ingredientsEditor');
            const addIngBtn = document.getElementById('addIng');
            if (ingredientsEditor) ingredientsEditor.innerHTML = '';
            (r.ingredientLines || []).forEach(line => {
                addIngBtn?.dispatchEvent(new Event('click'));
                const rows = ingredientsEditor?.querySelectorAll('.ingredient-row');
                const row  = rows?.[rows.length-1];
                const itemInput = row?.querySelector('.ing-item');
                if (itemInput) itemInput.value = line;
            });
            const stepsEditor = document.getElementById('stepsEditor');
            const addStepBtn = document.getElementById('addStep');
            if (stepsEditor) stepsEditor.innerHTML = '';
            (r.steps || []).forEach(text => {
                addStepBtn?.dispatchEvent(new Event('click'));
                const rows = stepsEditor?.querySelectorAll('.step-row input[type="text"]');
                const el = rows?.[rows.length-1];
                if (el) el.value = text;
            });
            alert('読み取りが完了しました。');
        } catch (e) {
            console.error(e);
            alert('読み取りに失敗しました: ' + (e.message || e));
        }
    }
    // ===== Vision/Gemini からの受け取り（ローカルストレージ / URLパラメータ） =====
    try {
      // URLパラメータ優先（file:// や別オリジン対策）
      const params = new URLSearchParams(location.search);
      const paramData = params.get('data');
      if (paramData) {
        const json = decodeURIComponent(escape(atob(paramData)));
        const data = JSON.parse(json);
        await applyRecipeData(data);
        history.replaceState(null, '', location.pathname); // URLクリーン
      }

      const raw = localStorage.getItem('recipe_from_vision');
      if (raw) {
        const data = JSON.parse(raw);
        await applyRecipeData(data);
        // 1回だけ使う
        localStorage.removeItem('recipe_from_vision');
      }
    } catch (_) {}

    // ヘルパ: Vision/GeminiのJSONをフォームに反映
    async function applyRecipeData(r) {
      // タイトル・説明・人数
      const titleEl = document.getElementById('title');
      if (titleEl) titleEl.value = (r.title || '').toString();
      const notesEl = document.getElementById('notes');
      if (notesEl) notesEl.value = (r.description || r.notes || '').toString();
      const servingsEl = document.getElementById('servings');
      const srv = r.servings; if (servingsEl && (srv || srv === 0)) servingsEl.value = parseInt(srv || 0, 10) || '';

      // 材料
      const ingredientsEditor = document.getElementById('ingredientsEditor');
      const addIngBtn = document.getElementById('addIng');
      if (ingredientsEditor) ingredientsEditor.innerHTML = '';
      // 受け取るフォーマットのゆらぎを吸収
      let ingredients = [];
      if (Array.isArray(r.ingredients)) {
        ingredients = r.ingredients.map(x => {
          if (typeof x === 'string') return { item: x };
          return { item: x.item || '', quantity: x.quantity || '', unit: x.unit || '' };
        });
      } else if (Array.isArray(r.ingredientLines)) {
        ingredients = r.ingredientLines.map(line => ({ item: line }));
      }

      for (const ing of ingredients) {
        addIngBtn?.dispatchEvent(new Event('click'));
        // 追加完了を待つ（エディタが行を挿入するのを待機）
        await new Promise(resolve => setTimeout(resolve, 0));
        const rows = ingredientsEditor?.querySelectorAll('.ingredient-row');
        const row  = rows?.[rows.length-1];
        // エディタのフィールド仕様に合わせて、存在すれば個別に代入
        const itemInput = row?.querySelector('.ing-item');
        const qtyInput  = row?.querySelector('.ing-qty');
        const unitInput = row?.querySelector('.ing-unit');
        const priceInput = row?.querySelector('.ing-price');
        const line = [ing.item, ing.quantity, ing.unit].filter(Boolean).join(' ');
        if (itemInput && (qtyInput || unitInput)) {
          if (itemInput) itemInput.value = (ing.item || '').toString();
          if (qtyInput)  qtyInput.value  = (ing.quantity || '').toString();
          if (unitInput) unitInput.value = (ing.unit || '').toString();
          if (priceInput) priceInput.value = (ing.price || '').toString();
        } else if (itemInput) {
          itemInput.value = line;
        }
      }

      // 手順
      const stepsEditor = document.getElementById('stepsEditor');
      const addStepBtn = document.getElementById('addStep');
      if (stepsEditor) stepsEditor.innerHTML = '';
      const steps = Array.isArray(r.steps) ? r.steps : Array.isArray(r.directions) ? r.directions : [];
      for (const text of steps) {
        addStepBtn?.dispatchEvent(new Event('click'));
        await new Promise(resolve => setTimeout(resolve, 0));
        const rows = stepsEditor?.querySelectorAll('.step-row input[type="text"]');
        const el = rows?.[rows.length-1];
        if (el) el.value = (text || '').toString();
      }
    }

    // ===== 画像解析機能 =====
    let currentFile = null;

    // 画像解析ボタンのイベントリスナー
    const imageImportBtn = document.getElementById('imageImportBtn');
    const imageImportModal = document.getElementById('image-import-modal');
    const imageImportModalCloseBtn = document.getElementById('image-import-modal-close-btn');
    const imageImportCancelBtn = document.getElementById('imageImportCancelBtn');
    const fileSelectBtn = document.getElementById('fileSelectBtn');
    const cameraBtn = document.getElementById('cameraBtn');
    const imageInput = document.getElementById('imageInput');
    const cameraInput = document.getElementById('cameraInput');
    const analyzeButton = document.getElementById('analyzeButton');
    const clearImageButton = document.getElementById('clearImageButton');

    // 画像解析ボタンのシンプル設定（DOMContentLoaded内）
    console.log('🔧 DOMContentLoaded内で画像解析ボタンを設定中...');
    
    if (imageImportBtn && imageImportModal) {
      console.log('✅ 画像解析ボタンとモーダルが見つかりました');
      
      // シンプルなクリックイベント
      imageImportBtn.onclick = function() {
        console.log('📷 画像解析ボタンがクリックされました！');
        imageImportModal.style.display = 'flex';
      };
      
      console.log('✅ 画像解析ボタンの設定完了');
    } else {
      console.error('❌ 画像解析ボタンまたはモーダルが見つかりません');
    }
    
    // テスト関数
    window.testImageButton = function() {
      console.log('🧪 画像解析ボタンのテストを開始...');
      const modal = document.getElementById('image-import-modal');
      if (modal) {
        modal.style.display = 'flex';
        console.log('✅ モーダルを表示しました');
        setTimeout(() => {
          modal.style.display = 'none';
          console.log('✅ モーダルを閉じました');
        }, 2000);
      } else {
        console.error('❌ モーダルが見つかりません');
      }
    };
    
    console.log('🧪 テスト関数を設定しました: window.testImageButton() をコンソールで実行してください');
    
    // 直接モーダル表示関数
    window.showImageModal = function() {
      const modal = document.getElementById('image-import-modal');
      if (modal) {
        modal.style.display = 'flex';
        console.log('✅ 画像解析モーダルを表示しました');
      } else {
        console.error('❌ 画像解析モーダルが見つかりません');
      }
    };
    
    console.log('🔧 直接表示関数を設定しました: window.showImageModal() をコンソールで実行してください');

    // モーダルを閉じる
    const closeImageModal = () => {
      imageImportModal.style.display = 'none';
      clearImage();
    };

    // モーダルを閉じるボタン
    if (imageImportModalCloseBtn) {
      imageImportModalCloseBtn.onclick = closeImageModal;
    }
    if (imageImportCancelBtn) {
      imageImportCancelBtn.onclick = closeImageModal;
    }

    // ファイル選択ボタン
    if (fileSelectBtn && imageInput) {
      fileSelectBtn.onclick = function() {
        imageInput.click();
      };
    }

    // カメラボタン
    if (cameraBtn && cameraInput) {
      cameraBtn.onclick = function() {
        cameraInput.click();
      };
    }

    // ファイル選択のイベント
    imageInput?.addEventListener('change', handleFileSelect);
    cameraInput?.addEventListener('change', handleFileSelect);

    function handleFileSelect(event) {
      const file = event.target.files[0];
      if (file) {
        handleFile(file);
      }
    }

    function handleFile(file) {
      console.log('📁 ファイル処理開始:', file.name);
      
      if (!file.type.startsWith('image/')) {
        showImageMessage('画像ファイルを選択してください', 'error');
        return;
      }

      currentFile = file;
      
      // プレビュー表示
      const reader = new FileReader();
      reader.onload = (e) => {
        const previewImage = document.getElementById('previewImage');
        const previewArea = document.getElementById('previewArea');
        
        previewImage.src = e.target.result;
        previewArea.style.display = 'block';
        
        console.log('✅ プレビュー表示完了');
        showImageMessage(`画像読み込み完了: ${file.name}`, 'success');
      };
      reader.readAsDataURL(file);
    }

    // 解析ボタン
    if (analyzeButton) {
      analyzeButton.onclick = analyzeImage;
    }

    // クリアボタン
    if (clearImageButton) {
      clearImageButton.onclick = clearImage;
    }

    async function analyzeImage() {
      if (!currentFile) {
        showImageMessage('画像を選択してください', 'error');
        return;
      }

      console.log('🚀 画像解析開始');
      showImageMessage('画像を解析中...', 'loading');
      
      // ステータス表示開始
      if (typeof showStatusPopup === 'function') {
        showStatusPopup('画像解析中...', 'AIが画像からレシピを抽出しています', 'loading');
      }

      try {
        // Base64変換
        const base64 = await fileToBase64(currentFile);
        const base64Data = base64.split(',')[1];
        
        console.log('📤 Gemini Vision API 呼び出し');
        console.log('ファイル名:', currentFile.name);
        console.log('ファイルタイプ:', currentFile.type);
        console.log('Base64データ長:', base64Data.length);
        
        // Gemini Vision APIを使用してOCRテキストを抽出
        const ocrPrompt = `以下の画像からレシピのテキストを抽出してください。材料、分量、手順を正確に読み取ってください。`;
        
        const ocrResponse = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-pro:generateContent?key=${GEMINI_API_KEY}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            contents: [{
              parts: [
                { text: ocrPrompt },
                { inline_data: { mime_type: currentFile.type, data: base64Data } }
              ]
            }]
          })
        });
        
        if (!ocrResponse.ok) {
          throw new Error('OCR処理に失敗しました');
        }
        
        const ocrResult = await ocrResponse.json();
        if (!ocrResult.candidates || !ocrResult.candidates[0] || !ocrResult.candidates[0].content) {
          throw new Error('OCR結果を取得できませんでした');
        }
        
        const extractedText = ocrResult.candidates[0].content.parts[0].text;
        console.log('✅ OCRテキスト抽出成功:', extractedText.substring(0, 200) + '...');
        
        // 抽出したテキストを構造化
        if (extractedText) {
          console.log('🤖 レシピ構造化中...');
          
          const prompt = `以下はOCRで抽出したレシピのテキストです。これを次の厳密なJSONスキーマで日本語の値として構造化してください。

スキーマ:
{
  "title": "料理名",
  "description": "レシピの説明", 
  "servings": "人数（数字のみ）",
  "ingredients": [
    { "item": "材料名", "quantity": "分量", "unit": "単位" }
  ],
  "steps": ["手順1", "手順2"],
  "notes": "メモやコツ"
}

要件:
- 値は日本語で記述
- 単位と分量を分離
- 有効なJSONのみを出力（前後に説明文を付けない）

OCRテキスト:
` + extractedText;

          const structureResponse = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-pro:generateContent?key=${GEMINI_API_KEY}`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              contents: [{
                parts: [{
                  text: prompt
                }]
              }]
            })
          });
          
          if (!structureResponse.ok) {
            console.log('❌ レシピ構造化エラー');
            recipeData = parseTextToRecipe(extractedText);
          } else {
            const structureResult = await structureResponse.json();
            console.log('✅ レシピ構造化成功:', structureResult);
            
            let generatedText = '';
            if (structureResult.candidates && structureResult.candidates[0] && structureResult.candidates[0].content) {
              generatedText = structureResult.candidates[0].content.parts[0].text;
            
            // JSONとしてパース
            try {
              // JSONのクリーンアップ（前後の不要なテキストを除去）
              let cleanJson = generatedText.trim();
              const jsonStart = cleanJson.indexOf('{');
              const jsonEnd = cleanJson.lastIndexOf('}') + 1;
              
              if (jsonStart >= 0 && jsonEnd > jsonStart) {
                cleanJson = cleanJson.substring(jsonStart, jsonEnd);
              }
              
              console.log('🧹 クリーンアップ済みJSON:', cleanJson);
              recipeData = JSON.parse(cleanJson);
              
              // データの妥当性チェック
              if (!recipeData.title && !recipeData.ingredients && !recipeData.steps) {
                throw new Error('有効なレシピデータが含まれていません');
              }
              
            } catch (e) {
              console.log('❌ JSON解析失敗、テキスト解析にフォールバック:', e.message);
              recipeData = parseTextToRecipe(extractedText);
            }
          }
        }
        
        console.log('📄 最終レシピデータ:', recipeData);

        // 既存の applyRecipeData 関数を使用してフォームに反映
        if (recipeData) {
          await applyRecipeData(recipeData);
          showImageMessage('画像解析が完了しました！', 'success');
          
          // ステータス表示完了
          if (typeof updateStatusPopup === 'function') {
            updateStatusPopup('完了', '画像解析が完了しました！', 'success');
            setTimeout(() => {
              if (typeof hideStatusPopup === 'function') {
                hideStatusPopup();
              }
            }, 2000);
          }
          
          // モーダルを閉じる
          closeImageModal();
        } else {
          showImageMessage('レシピデータの抽出に失敗しました', 'error');
          
          // ステータス表示エラー
          if (typeof updateStatusPopup === 'function') {
            updateStatusPopup('エラー', 'レシピデータの抽出に失敗しました', 'error');
            setTimeout(() => {
              if (typeof hideStatusPopup === 'function') {
                hideStatusPopup();
              }
            }, 3000);
          }
        }
        
      } catch (error) {
        console.error('❌ 解析エラー:', error);
        showImageMessage('画像解析に失敗しました: ' + error.message, 'error');
        
        // ステータス表示エラー
        if (typeof updateStatusPopup === 'function') {
          updateStatusPopup('エラー', '画像解析に失敗しました', 'error');
          setTimeout(() => {
            if (typeof hideStatusPopup === 'function') {
              hideStatusPopup();
            }
          }, 3000);
        }
      }
    }

    function parseTextToRecipe(text) {
      // OCRテキストからレシピ情報を抽出
      const lines = text.split('\n').filter(line => line.trim());
      
      // タイトルを探す（最初の行または料理名らしい行）
      let title = 'OCRで抽出したレシピ';
      const titleCandidates = lines.filter(line => 
        !line.includes('材料') && 
        !line.includes('作り方') && 
        !line.includes('手順') &&
        line.length > 2 && line.length < 30
      );
      if (titleCandidates.length > 0) {
        title = titleCandidates[0];
      }
      
      // 材料部分を抽出
      const ingredients = [];
      const ingredientStartIndex = lines.findIndex(line => 
        line.includes('材料') || line.includes('ingredient')
      );
      
      if (ingredientStartIndex >= 0) {
        const stepsStartIndex = lines.findIndex(line => 
          line.includes('作り方') || line.includes('手順') || line.includes('step')
        );
        
        const endIndex = stepsStartIndex >= 0 ? stepsStartIndex : Math.min(ingredientStartIndex + 10, lines.length);
        
        for (let i = ingredientStartIndex + 1; i < endIndex; i++) {
          const line = lines[i].trim();
          if (line && line.length > 1) {
            ingredients.push({ item: line, quantity: '', unit: '' });
          }
        }
      }
      
      // 手順部分を抽出
      const steps = [];
      const stepsStartIndex = lines.findIndex(line => 
        line.includes('作り方') || line.includes('手順') || line.includes('step')
      );
      
      if (stepsStartIndex >= 0) {
        for (let i = stepsStartIndex + 1; i < lines.length; i++) {
          const line = lines[i].trim();
          if (line && line.length > 2) {
            steps.push(line);
          }
        }
      }
      
      // 人数を推測
      let servings = 2;
      const servingLine = lines.find(line => 
        line.includes('人分') || line.includes('人前') || line.match(/\d+人/)
      );
      if (servingLine) {
        const match = servingLine.match(/(\d+)/);
        if (match) servings = parseInt(match[1]);
      }
      
      return {
        title: title,
        description: `OCRで抽出されたレシピです。\n\n${text.substring(0, 150)}...`,
        servings: servings,
        ingredients: ingredients.length > 0 ? ingredients : [{ item: '材料情報が見つかりませんでした', quantity: '', unit: '' }],
        steps: steps.length > 0 ? steps : ['手順情報が見つかりませんでした']
      };
    }

    function clearImage() {
      currentFile = null;
      const previewArea = document.getElementById('previewArea');
      const imageInput = document.getElementById('imageInput');
      const cameraInput = document.getElementById('cameraInput');
      const messageArea = document.getElementById('imageMessageArea');
      
      if (previewArea) previewArea.style.display = 'none';
      if (imageInput) imageInput.value = '';
      if (cameraInput) cameraInput.value = '';
      if (messageArea) messageArea.innerHTML = '';
      
      console.log('🗑️ 画像クリア完了');
    }

    function showImageMessage(message, type = 'info') {
      const messageArea = document.getElementById('imageMessageArea');
      if (!messageArea) return;
      
      const className = type === 'error' ? 'error-message' : 
                      type === 'success' ? 'success-message' : 'loading-message';
      
      messageArea.innerHTML = `<div class="${className}">${message}</div>`;
      
      if (type === 'success') {
        setTimeout(() => {
          messageArea.innerHTML = '';
        }, 3000);
      }
    }

    function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

  });
  </script>
</body>
</html>
