<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>レシピ表示 — Recipe Box</title>
  
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.0.2/marked.min.js"></script>
  
  <link rel="stylesheet" href="assets/css/style.css">
</head>
<body>

  <header class="app-header">
    <h1 class="brand">レシピ表示</h1>
    <div class="header-actions" data-actions>
      <button class="btn primary small js-ai-advice">✨ AIアドバイス</button>
      <button class="btn js-edit">編集</button>
      <button class="btn ghost js-delete" style="color: #c0392b; border-color: #c0392b;">削除</button>
      <button class="btn js-back">戻る</button>
    </div>
  </header>

  <main class="container two-col-layout">
    <article class="panel">
      <div class="fav-block" style="text-align: right; margin-bottom: 1rem;">
        <button id="favBtn" class="btn small">♡ お気に入り</button>
      </div>

      <h2 id="recipeTitle">タイトル</h2>
      <div class="muted" id="meta">作成日 — / 更新日 —</div>
      <div id="tags" style="margin:8px 0;"></div>
      <p id="recipeIntro" class="lead"></p>
      <div id="notes" style="margin-top:16px;white-space:pre-wrap;"></div>
    </article>

    <aside class="panel">
      <h3>材料</h3>
      <div id="ingredients">
        <div class="muted">未登録</div>
      </div>

      <h3 style="margin-top:24px;">手順</h3>
      <ol id="steps">
        <li class="muted">未登録</li>
      </ol>
    </aside>
  </main>

  <footer class="app-footer">
    <div><a href="index.html">一覧へ</a></div>
  </footer>

  <div id="ai-view-modal" class="ai-view-modal-overlay">
    <div class="ai-view-modal-content">
      <header class="ai-view-modal-header">
        <h3 class="ai-view-modal-title">✨ AI レシピ アシスタント</h3>
        <button id="ai-view-modal-close" class="ai-view-modal-close">&times;</button>
      </header>
      <div id="ai-chat-container" class="ai-chat-container">
        </div>
      <div class="ai-input-container">
        <textarea id="ai-user-input" class="input" placeholder="質問や要望を入力..." rows="1"></textarea>
        <button id="ai-send-btn" class="btn primary">送信</button>
      </div>
      <div class="ai-modal-actions">
        <button id="ai-save-new-btn" class="btn primary">この内容で新規作成</button>
      </div>
    </div>
  </div>

  <script>
(function(){
  const params = new URLSearchParams(location.search);
  const id = params.get('id');

  // --- Supabase Client ---
  if (window.supabase && !window.sb) {
    window.sb = window.supabase.createClient("https://ctxyawinblwcbkovfsyj.supabase.co", "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN0eHlhd2luYmx3Y2Jrb3Zmc3lqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ5NzE3MzIsImV4cCI6MjA3MDU0NzczMn0.HMMoDl_LPz8uICruD_tzn75eUpU7rp3RZx_N8CEfO1Q");
  }
  if(!window.sb){ alert('Supabase not initialized'); return; }
  if(!id){ alert('レシピIDがありません'); location.href='index.html'; return; }

  // --- Element Selection ---
  const titleEl = document.querySelector('#recipeTitle');
  const metaEl = document.querySelector('#meta');
  const tagsEl = document.querySelector('#tags');
  const favBtn = document.querySelector('#favBtn');
  const introEl = document.querySelector('#recipeIntro');
  const notesEl = document.querySelector('#notes');
  const ingEl = document.querySelector('#ingredients');
  const stepsEl = document.querySelector('#steps');
  const aiModal = document.querySelector('#ai-view-modal');
  const aiModalCloseBtn = document.querySelector('#ai-view-modal-close');
  const aiChatContainer = document.querySelector('#ai-chat-container');
  const aiUserInput = document.querySelector('#ai-user-input');
  const aiSendBtn = document.querySelector('#ai-send-btn');
  const aiSaveNewBtn = document.querySelector('#ai-save-new-btn');
  
  // --- State ---
  let recipeData = {};
  let chatHistory = [];
  let isAiLoading = false;

  // --- Helper Functions ---
  const esc = (s) => String(s ?? '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  const getClientId = () => {
    let clientId = localStorage.getItem("client_id");
    if (!clientId) {
        clientId = crypto?.randomUUID?.() || String(Math.random()).slice(2);
        localStorage.setItem("client_id", clientId);
    }
    return clientId;
  };

  // --- Main Logic ---
  async function deleteRecipe() {
    if (!confirm('このレシピを完全に削除しますか？')) return;
    const { error } = await sb.from('recipes').delete().eq('id', id);
    if (error) {
      alert('レシピの削除に失敗しました: ' + error.message);
    } else {
      alert('レシピを削除しました。');
      location.href = 'index.html';
    }
  }
  async function loadRecipe() {
    try {
      const { data: r, error } = await sb.from('recipes').select('*').eq('id', id).single();
      if (error || !r) throw new Error('レシピの読み込みに失敗しました。');
      
      recipeData = {
        title: r.title || '無題のレシピ',
        intro: r.intro || '',
        notes: r.notes || r.meta?.note || '',
        tags: r.tags || [],
      };

      titleEl.textContent = recipeData.title;
      metaEl.textContent = r.updated_at ? `更新: ${new Date(r.updated_at).toLocaleString('ja-JP')}` : '';
      tagsEl.innerHTML = recipeData.tags.map(t => `<span class="tag">${esc(t)}</span>`).join('');
      introEl.textContent = recipeData.intro;
      notesEl.textContent = recipeData.notes;

      const { data: ings } = await sb.from('recipe_ingredients').select('item,quantity,unit').eq('recipe_id', id).order('position');
      recipeData.ingredients = ings || [];
      ingEl.innerHTML = ings?.length ? `<table class="table"><thead><tr><th>材料名</th><th class="num">分量</th><th>単位</th></tr></thead><tbody>${ings.map(i => `<tr><td>${esc(i.item)}</td><td class="num">${esc(i.quantity ?? '')}</td><td>${esc(i.unit ?? '')}</td></tr>`).join('')}</tbody></table>` : '<div class="muted">材料は登録されていません。</div>';

      const { data: steps } = await sb.from('recipe_steps').select('instruction').eq('recipe_id', id).order('position');
      recipeData.steps = steps?.map(s => s.instruction) || [];
      stepsEl.innerHTML = steps?.length > 0 ? steps.map(s => `<li>${esc(s.instruction)}</li>`).join('') : '<li class="muted">手順は登録されていません。</li>';

      setupFavoriteButton(id);
    } catch (err) {
      alert(err.message);
      location.href = 'index.html';
    }
  }

  // --- AI Logic ---
  function renderChatMessage(message, role) {
    const messageEl = document.createElement('div');
    messageEl.className = `ai-chat-message ${role}`;
    messageEl.innerHTML = role === 'assistant' ? marked.parse(message) : esc(message);
    aiChatContainer.appendChild(messageEl);
    aiChatContainer.scrollTop = aiChatContainer.scrollHeight;
  }
  function toggleAiLoading(show) {
    isAiLoading = show;
    aiSendBtn.disabled = show;
    aiUserInput.disabled = show;
    
    const existingSpinner = aiChatContainer.querySelector('.loading-spinner-small');
    if (existingSpinner) existingSpinner.remove();

    if (show) {
      const spinner = document.createElement('div');
      spinner.className = 'loading-spinner-small';
      aiChatContainer.appendChild(spinner);
      aiChatContainer.scrollTop = aiChatContainer.scrollHeight;
    }
  }
  async function callGeminiApi(prompt, responseSchema) {
    toggleAiLoading(true);
    try {
        const { data, error } = await sb.functions.invoke('call-gemini', {
            body: { prompt, responseSchema },
        });
        if (error) throw new Error(`Edge Function Error: ${error.message}`);
        if (data.error) throw new Error(`API Error from Edge Function: ${data.error}`);
        return data;
    } catch(err) {
        console.error("AI Error:", err);
        renderChatMessage(`エラーが発生しました: ${err.message}`, 'assistant');
    } finally {
        toggleAiLoading(false);
    }
  }
  async function handleAiAdviceClick() {
    if (!aiModal) return;
    aiModal.style.display = 'flex';
    aiChatContainer.innerHTML = '';
    
    const ingredientsText = recipeData.ingredients.map(i => `- ${i.item} ${i.quantity || ''} ${i.unit || ''}`).join('\n');
    const stepsText = recipeData.steps.map((s, i) => `${i + 1}. ${s}`).join('\n');
    
    const initialPrompt = `あなたは調理科学者です。以下のルセットを分析し、同業者向けに質を向上させる改善提案をしてください。提案はメイラード反応、酵素の働き、タンパク質の変性、乳化等の調理科学の原理に基づき、科学的根拠を明確に示しながら記述してください。\n\n# ルセット名: ${recipeData.title}\n\n## 材料\n${ingredientsText}\n\n## 手順\n${stepsText}`;
    
    chatHistory = [{ role: "user", parts: [{ text: initialPrompt }] }];
    
    const result = await callGeminiApi(initialPrompt);
    if(result){
        const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
        if (!text) { renderChatMessage('AIからの応答が空でした。', 'assistant'); return; }
        chatHistory.push({ role: "model", parts: [{ text }] });
        renderChatMessage(text, 'assistant');
    }
  }
  async function handleSendMessage() {
    const userInput = aiUserInput.value.trim();
    if (!userInput || isAiLoading) return;

    renderChatMessage(userInput, 'user');
    chatHistory.push({ role: "user", parts: [{ text: userInput }] });
    aiUserInput.value = '';
    
    const result = await callGeminiApi(userInput);
    if(result){
        const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
        if (!text) { renderChatMessage('AIからの応答が空でした。', 'assistant'); return; }
        chatHistory.push({ role: "model", parts: [{ text }] });
        renderChatMessage(text, 'assistant');
    }
  }
  async function handleSaveAsNew() {
      const savePrompt = `これまでの会話に基づき、最終的なレシピをJSONで提供してください。備考は含めずJSONオブジェクトのみを返してください。キーは "title", "category", "tags", "notes", "ingredients" (item, quantity, unit を含むオブジェクトの配列), "steps" (文字列の配列) としてください。単位はgやmlを基本とすること。`;
      
      chatHistory.push({ role: "user", parts: [{ text: savePrompt }] });
      
      const responseSchema = {
          type: "OBJECT",
          properties: { "title": { "type": "STRING" }, "category": { "type": "STRING" }, "tags": { "type": "ARRAY", items: { "type": "STRING" } }, "notes": { "type": "STRING" }, "ingredients": { "type": "ARRAY", items: { "type": "OBJECT", "properties": { "item": { "type": "STRING" }, "quantity": { "type": "STRING" }, "unit": { "type": "STRING" } }, required: ["item"] } }, "steps": { "type": "ARRAY", items: { "type": "STRING" } } },
          required: ["title", "category", "tags", "notes", "ingredients", "steps"]
      };

      try {
        const result = await callGeminiApi(savePrompt, responseSchema);
        const jsonText = result?.candidates?.[0]?.content?.parts?.[0]?.text;
        if (!jsonText) throw new Error('AIからのJSON応答がありませんでした。');

        localStorage.setItem('ai_generated_recipe', jsonText);
        alert('AIが提案したレシピを編集画面に読み込みます。');
        location.href = 'recipe_edit.html';
      } catch (error) {
        alert(`新規保存の準備に失敗しました: ${error.message}`);
        chatHistory.pop(); 
      }
  }

  // --- Event Listeners & Initial Load ---
  document.addEventListener('click', (e) => {
    const target = e.target.closest('button');
    if (!target) return;
    if (target.classList.contains('js-edit')) location.href = `recipe_edit.html?id=${id}`;
    else if (target.classList.contains('js-back')) location.href = 'index.html';
    else if (target.classList.contains('js-delete')) deleteRecipe();
    else if (target.classList.contains('js-ai-advice')) handleAiAdviceClick();
  });
  if (aiModal) {
    aiModalCloseBtn.addEventListener('click', () => aiModal.style.display = 'none');
    aiSendBtn.addEventListener('click', handleSendMessage);
    aiSaveNewBtn.addEventListener('click', handleSaveAsNew);
    aiUserInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleSendMessage(); }
    });
  }
  async function setupFavoriteButton(recipe_id) {
    const clientId = getClientId();
    const { data } = await sb.from("favorites").select("id").eq("recipe_id", recipe_id).eq("client_id", clientId).limit(1);
    let isFavorite = data && data.length > 0;
    const updateButton = () => {
        favBtn.innerHTML = isFavorite ? '♥ お気に入り' : '♡ お気に入り';
        favBtn.classList.toggle('danger', isFavorite);
    };
    updateButton();
    favBtn.addEventListener('click', async () => {
        const originalState = isFavorite;
        isFavorite = !isFavorite;
        updateButton();
        try {
            if (isFavorite) await sb.from("favorites").insert({ recipe_id, client_id: clientId });
            else await sb.from("favorites").delete().eq("recipe_id", recipe_id).eq("client_id", clientId);
        } catch (err) {
            alert("お気に入り状態の更新に失敗しました。");
            isFavorite = originalState;
            updateButton();
        }
    });
  }
  loadRecipe();
})();
  </script>
</body>
<section class="card">
  <h3>材料 <span id="servingsLabel"></span></h3>
  <ul id="ingredientsList"></ul>
</section>

<section class="card">
  <h3>手順</h3>
  <ol id="stepsList"></ol>
</section>

<section class="card">
  <h3>科学メモ（ベーカーズ％）</h3>
  <div id="analysisBox">
    <div>粉合計: <span id="flour_g">–</span> g (100%)</div>
    <div>加水率: <span id="hydration_bp">–</span>% （水分 <span id="water_g">–</span> g）</div>
    <div>油脂: <span id="fat_bp">–</span>% （<span id="fat_g">–</span> g）</div>
    <div>糖: <span id="sugar_bp">–</span>% （<span id="sugar_g">–</span> g）</div>
    <div>塩: <span id="salt_bp">–</span>% （<span id="salt_g">–</span> g）</div>
    <div>酵母: <span id="yeast_bp">–</span>% （<span id="yeast_g">–</span> g）</div>
    <p id="analysisNotes" class="note"></p>
  </div>
</section>

<section class="card">
  <label>人数:
    <input id="servingsInput" type="number" min="1" step="1" value="2">
  </label>
  <button id="btnScale" type="button">分量を再計算</button>
</section>

</html>
