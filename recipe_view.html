<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>レシピ表示 — Recipe Box</title>

  <!-- Supabase / Marked -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.0.2/marked.min.js"></script>

  <link rel="stylesheet" href="assets/css/style.css">
  <style>
    /* ===== AIモーダル（3タブ統合版） ===== */
    .ai-view-modal-overlay{ position:fixed; inset:0; background:rgba(0,0,0,.45); z-index:1000; display:none; align-items:center; justify-content:center; }
    .ai-view-modal-content{ background:var(--bg-panel,#fff); color:var(--fg,#222); width:clamp(320px,92vw,860px); max-height:92vh; overflow:hidden; border-radius:12px; box-shadow:0 8px 28px rgba(0,0,0,.35); display:flex; flex-direction:column; }
    .ai-view-modal-header{ display:flex; align-items:center; justify-content:space-between; gap:1rem; padding:.85rem 1rem; border-bottom:1px solid rgba(0,0,0,.08); }
    .ai-view-modal-title{ font-weight:700; }
    .ai-view-modal-close{ background:none; border:none; font-size:1.5rem; line-height:1; cursor:pointer; }
    .ai-view-tabs{ display:flex; gap:.25rem; padding:.5rem; border-bottom:1px solid rgba(0,0,0,.06); background:var(--bg-muted,#f7f7f7); }
    .ai-tab{ padding:.4rem .75rem; border-radius:999px; cursor:pointer; border:1px solid transparent; }
    .ai-tab[aria-selected="true"]{ background:#e8f0fe; border-color:#b6cef7; }
    .ai-chat-container{ flex:1; overflow:auto; padding:1rem; display:none; }
    .ai-chat-container.active{ display:block; }
    .ai-input-row{ display:flex; gap:.5rem; padding:.75rem 1rem; border-top:1px solid rgba(0,0,0,.08); }
    .ai-input-row textarea{ flex:1; resize:vertical; min-height:42px; }
    .ai-btn{ padding:.5rem .85rem; border:1px solid #d0d7de; border-radius:8px; background:#fff; cursor:pointer; }
    .ai-btn.primary{ background:#2563eb; color:#fff; border-color:#2563eb; }
    .ai-msg{ margin:.45rem 0; padding:.6rem .8rem; border-radius:8px; border:1px solid #e5e7eb; background:#fafafa; line-height:1.6; }
    .ai-msg.user{ background:#eef5ff; border-color:#cfe2ff; }
    .loading{ width:24px; height:24px; border:3px solid rgba(0,0,0,.15); border-top-color:rgba(0,0,0,.45); border-radius:50%; animation:spin 1s linear infinite; margin:.25rem auto; }
    @keyframes spin{ to{ transform:rotate(360deg);} }
    body.modal-open{ overflow:hidden; }
    /* 既存の解析カードの体裁補助 */
    .grid{ display:grid; grid-template-columns: 1fr auto; gap:.25rem .75rem; align-items:baseline; }
    .card .num{ text-align:right; }
  </style>
</head>
<body>

  <header class="app-header">
    <h1 class="brand">レシピ表示</h1>
    <div class="header-actions" data-actions>
      <button class="btn primary small js-ai-advice">✨ AIアドバイス</button>
      <button class="btn js-edit">編集</button>
      <button class="btn ghost js-delete" style="color:#c0392b;border-color:#c0392b;">削除</button>
      <button class="btn js-back">戻る</button>
    </div>
  </header>

  <main class="container two-col-layout">
    <!-- 左カラム：本文 -->
    <article class="panel">
      <div class="fav-block" style="text-align:right;margin-bottom:1rem;">
        <button id="favBtn" class="btn small">♡ お気に入り</button>
      </div>
      <h2 id="recipeTitle">タイトル</h2>
      <div class="muted" id="meta">作成日 — / 更新日 —</div>
      <div id="tags" style="margin:8px 0;"></div>
      <p id="recipeIntro" class="lead"></p>
      <div id="notes" style="margin-top:16px;white-space:pre-wrap;"></div>
    </article>

    <!-- 右カラム：材料・手順・解析・スケール -->
    <aside class="panel">
      <h3>材料</h3>
      <div id="ingredients"><div class="muted">未登録</div></div>

      <h3 style="margin-top:24px;">手順</h3>
      <ol id="steps"><li class="muted">未登録</li></ol>

      <!-- 科学メモ（ベーカーズ％） -->
      <section class="card" id="analysisSection" style="display:none;">
        <h3>科学メモ（ベーカーズ％）</h3>
        <div class="grid">
          <div>粉合計</div><div><span id="flour_g">–</span> g (100%)</div>
          <div>加水率</div><div><span id="hydration_bp">–</span>%（水分 <span id="water_g">–</span> g）</div>
          <div>油脂</div><div><span id="fat_bp">–</span>%（<span id="fat_g">–</span> g）</div>
          <div>糖</div><div><span id="sugar_bp">–</span>%（<span id="sugar_g">–</span> g）</div>
          <div>塩</div><div><span id="salt_bp">–</span>%（<span id="salt_g">–</span> g）</div>
          <div>酵母</div><div><span id="yeast_bp">–</span>%（<span id="yeast_g">–</span> g）</div>
        </div>
        <p id="analysisNotes" class="note"></p>
      </section>

      <!-- 人数スケール -->
      <section class="card" id="scaleSection">
        <label>人数:
          <input id="servingsInput" type="number" min="1" step="1" value="2" style="width:6em;">
        </label>
        <button id="btnScale" type="button">分量を再計算</button>
      </section>
    </aside>
  </main>

  <footer class="app-footer">
    <div><a href="index.html">一覧へ</a></div>
  </footer>

  <!-- ===== AI レシピ アドバイス（3タブ モーダル） ===== -->
  <div id="aiModal" class="ai-view-modal-overlay" role="dialog" aria-modal="true" aria-labelledby="aiTitle">
    <div class="ai-view-modal-content" tabindex="-1">
      <header class="ai-view-modal-header">
        <div class="ai-view-modal-title" id="aiTitle">✨ AI レシピ アシスタント</div>
        <button class="ai-view-modal-close" id="aiClose" aria-label="閉じる">×</button>
      </header>
      <nav class="ai-view-tabs" role="tablist">
        <button class="ai-tab" role="tab" aria-selected="true" data-tab="advice">提案</button>
        <button class="ai-tab" role="tab" aria-selected="false" data-tab="temps">温度・時間</button>
        <button class="ai-tab" role="tab" aria-selected="false" data-tab="hazards">危害要因</button>
      </nav>
      <section id="tab-advice" class="ai-chat-container active"></section>
      <section id="tab-temps" class="ai-chat-container"></section>
      <section id="tab-hazards" class="ai-chat-container"></section>
      <div class="ai-input-row">
        <textarea id="aiInput" placeholder="質問や要望を入力…"></textarea>
        <button class="ai-btn" id="aiSave">新規レシピ化</button>
        <button class="ai-btn primary" id="aiSend">送信</button>
      </div>
    </div>
  </div>

  <script>
    // ===== Supabase 初期化（既に window.sb があれば流用） =====
    if (window.supabase && !window.sb) {
      window.sb = window.supabase.createClient(
        "https://ctxyawinblwcbkovfsyj.supabase.co",
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN0eHlhd2luYmx3Y2Jrb3Zmc3lqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ5NzE3MzIsImV4cCI6MjA3MDU0NzczMn0.HMMoDl_LPz8uICruD_tzn75eUpU7rp3RZx_N8CEfO1Q"
      );
    }

    // ===== 要素参照 =====
    const btnOpen = document.querySelector('.js-ai-advice');
    const btnBack = document.querySelector('.js-back');
    const modal = document.getElementById('aiModal');
    const modalContent = modal.querySelector('.ai-view-modal-content');
    const btnClose = document.getElementById('aiClose');
    const tabs = document.querySelectorAll('.ai-tab');
    const panes = { advice: document.getElementById('tab-advice'), temps: document.getElementById('tab-temps'), hazards: document.getElementById('tab-hazards') };
    const input = document.getElementById('aiInput');
    const btnSend = document.getElementById('aiSend');
    const btnSave = document.getElementById('aiSave');

    // ===== タブ切替（遅延生成対応） =====
    const tabLoaded = { advice:false, temps:false, hazards:false };
    tabs.forEach(t=>t.addEventListener('click', async ()=>{
      tabs.forEach(x=>x.setAttribute('aria-selected','false'));
      t.setAttribute('aria-selected','true');
      Object.values(panes).forEach(p=>p.classList.remove('active'));
      panes[t.dataset.tab].classList.add('active');
      if(!tabLoaded[t.dataset.tab]){ await generateTab(t.dataset.tab); tabLoaded[t.dataset.tab]=true; }
    }));

    // ===== 開閉（Esc/背景クリック/戻る導線） =====
    const openModal = ()=>{ modal.style.display='flex'; document.body.classList.add('modal-open'); modalContent.focus({preventScroll:true}); };
    const closeModal = ()=>{ modal.style.display='none'; document.body.classList.remove('modal-open'); };
    btnOpen?.addEventListener('click', async ()=>{ openModal(); await generateTab('advice'); tabLoaded.advice=true; });
    btnClose?.addEventListener('click', closeModal);
    modal.addEventListener('click', (e)=>{ if(e.target === modal) closeModal(); });
    document.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && modal.style.display==='flex') closeModal(); });
    btnBack?.addEventListener('click', ()=>{ location.href='index.html'; });

    // ===== 便利関数 =====
    const md = (s)=>{ try{ return marked.parse(s||''); }catch{ return (s||''); } };
    const pushMsg = (pane, role, text)=>{ const el=document.createElement('div'); el.className=`ai-msg ${role}`; el.innerHTML = role==='assistant'? md(text): (text||''); pane.appendChild(el); pane.scrollTop=pane.scrollHeight; };
    const spinner = ()=>{ const d=document.createElement('div'); d.className='loading'; return d; };

    // ===== レシピ抽出 =====
    function scrapeRecipe(){
      const title = document.getElementById('recipeTitle')?.textContent?.trim() || '';
      const ings = Array.from(document.querySelectorAll('#ingredients tbody tr')).map(tr=>{
        const tds = tr.querySelectorAll('td');
        return { item:(tds[0]?.textContent||'').trim(), quantity:(tds[1]?.textContent||'').trim(), unit:(tds[2]?.textContent||'').trim() };
      });
      const steps = Array.from(document.querySelectorAll('#steps li')).map(li=> (li.textContent||'').trim()).filter(Boolean);
      return { title, ings, steps };
    }

    // ===== タブ別プロンプト =====
    function buildPrompts(){
      const { title, ings, steps } = scrapeRecipe();
      const ingText = ings.map(i=>`- ${i.item} ${i.quantity||''} ${i.unit||''}`).join('\n');
      const stepText = steps.map((s,i)=> `${i+1}. ${s}`).join('\n');
      const base = `# ルセット名\n${title||'無題のレシピ'}\n\n## 材料\n${ingText}\n\n## 手順\n${stepText}`;
      const advice = `あなたはプロ向けの調理科学アドバイザーです。${base}\n\n— 出力仕様 —\n1) 改善提案（3–6個）：各項目に【根拠】【実装】【リスク】。\n2) 科学根拠：メイラード反応、酵素活性、タンパク質変性、乳化・起泡、デンプン糊化/老化、aw、pH、塩濃度、脂肪結晶多形。\n3) パン/生地系ではベーカーズ％（塩1.8–2.2%、糖0–12%、油脂0–8%、加水率の妥当性）に言及。`;
      const temps = `以下のレシピに対し、重要工程の温度・時間の推奨レンジを表形式（工程/中心or表面温度/時間/備考）で。食品安全の根拠を簡潔に。\n\n${base}`;
      const hazards = `以下のレシピに関する危害要因（微生物/アレルゲン/化学・物理）とCCP候補、簡単な管理基準案を箇条書きで。\n\n${base}`;
      return { advice, temps, hazards };
    }

    // ===== Supabase Edge Function 呼び出し =====
    async function invokeGemini(prompt, responseSchema){
      if (!window.sb){ pushMsg(panes.advice,'assistant','Supabase が初期化されていません。'); return null; }
      const load = spinner();
      const activePane = document.querySelector('.ai-chat-container.active') || panes.advice;
      activePane.appendChild(load);
      try{
        const { data, error } = await sb.functions.invoke('call-gemini', { body:{ prompt, responseSchema } });
        if (error) throw new Error(error.message);
        if (data?.error) throw new Error(data.error);
        return data;
      }catch(e){ pushMsg(activePane,'assistant',`エラー: ${e.message}`); return null; }
      finally{ load.remove(); }
    }

    // ===== タブ内容生成（必要時に呼び出し） =====
    async function generateTab(kind){
      const { advice, temps, hazards } = buildPrompts();
      if (kind === 'advice'){
        panes.advice.innerHTML = ''; pushMsg(panes.advice,'assistant','レシピを解析中…');
        const r = await invokeGemini(advice);
        const t = r?.candidates?.[0]?.content?.parts?.[0]?.text || '（結果なし）';
        panes.advice.innerHTML = md(t);
      }
      if (kind === 'temps'){
        panes.temps.innerHTML = ''; pushMsg(panes.temps,'assistant','温度・時間の推奨を生成中…');
        const r = await invokeGemini(temps);
        const t = r?.candidates?.[0]?.content?.parts?.[0]?.text || '（結果なし）';
        panes.temps.innerHTML = md(t);
      }
      if (kind === 'hazards'){
        panes.hazards.innerHTML = ''; pushMsg(panes.hazards,'assistant','危害要因の洗い出し中…');
        const r = await invokeGemini(hazards);
        const t = r?.candidates?.[0]?.content?.parts?.[0]?.text || '（結果なし）';
        panes.hazards.innerHTML = md(t);
      }
    }

    // ===== 入出力（質問/応答） =====
    btnSend.addEventListener('click', async ()=>{
      const q = input.value.trim(); if(!q) return;
      const pane = document.querySelector('.ai-chat-container.active');
      pushMsg(pane,'user',q); input.value='';
      const r = await invokeGemini(q);
      const t = r?.candidates?.[0]?.content?.parts?.[0]?.text || '（結果なし）';
      pushMsg(pane,'assistant',t);
    });
    input.addEventListener('keydown', (e)=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); btnSend.click(); }});

    // ===== 新規レシピ化（JSON + 単位正規化） =====
    btnSave.addEventListener('click', async ()=>{
      const schema = { type:"OBJECT", properties:{ title:{type:"STRING"}, category:{type:"STRING"}, tags:{type:"ARRAY",items:{type:"STRING"}}, notes:{type:"STRING"}, ingredients:{type:"ARRAY", items:{type:"OBJECT", properties:{ item:{type:"STRING"}, quantity:{type:"STRING"}, unit:{type:"STRING"} }, required:["item"]}}, steps:{type:"ARRAY",items:{type:"STRING"}} }, required:["title","category","tags","notes","ingredients","steps"] };
      const { advice } = buildPrompts();
      const prompt = advice + "\n\n— 出力仕様 追加 —\n4) 完成レシピをJSONで返す（g/mlを基本、単位省略不可）。\n5) 同義単位は g/ml に変換（tsp=5ml, tbsp=15ml, 小さじ=5ml, 大さじ=15ml）。";
      const r = await invokeGemini(prompt, schema);
      const jsonText = r?.candidates?.[0]?.content?.parts?.[0]?.text;
      if (!jsonText){ alert('JSONを取得できませんでした。'); return; }
      try{
        const obj = JSON.parse(jsonText);
        const unitMap = { 'tsp':'ml', 'tbsp':'ml', '小さじ':'ml', '大さじ':'ml' };
        const toVol = (q,u)=>{ const n=Number(q); if(!Number.isFinite(n)) return q; if(u==='tsp'||u==='小さじ') return n*5; if(u==='tbsp'||u==='大さじ') return n*15; return n; };
        obj.ingredients = (obj.ingredients||[]).map(it=>{ const u=(it.unit||'').toLowerCase(); if(unitMap[u]) return { ...it, quantity:String(toVol(it.quantity,u)), unit:'ml' }; return it; });
        localStorage.setItem('ai_generated_recipe', JSON.stringify(obj));
        alert('AIレシピを編集画面に読み込みます。');
        location.href = 'recipe_edit.html';
      }catch(e){ alert('JSONの解析に失敗: '+ e.message); }
    });
  </script>
</body>
</html>
