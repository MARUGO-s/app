import operationGuideKnowledge from '../data/operationGuideKnowledge.json';

const CORE_OPERATION_KB = [
    {
        id: 'recipe_create_manual',
        title: 'レシピを手入力で新規作成する',
        keywords: ['レシピ追加', '新規作成', '作成', '手入力', 'create', '登録', '必須項目', '入力項目', '保存できない', 'タイトル'],
        views: ['list', 'create'],
        steps: [
            'レシピ一覧画面で「+ レシピ追加」を押します。',
            'タイトルを入力します（タイトルは必須です）。',
            'コース・カテゴリー・店舗名・分量・説明・引用元URLを必要に応じて入力します。',
            '材料タブで材料名・分量・単位・仕入れを入力します（候補選択と手入力のどちらでも可）。',
            '作り方タブで手順を入力し、必要ならグループ分け・並び替えを行います。',
            '画像が必要な場合は画像カードで選択またはドラッグ&ドロップします。',
            '「レシピを保存」を押して登録します。'
        ],
        notes: '作成途中で戻ると未保存内容は失われます。コード上はタイトルが必須で、DB側制約はタイトル200文字以内・説明1000文字以内・材料200件以内です。'
    },
    {
        id: 'recipe_create_web_import',
        title: 'Web URLからレシピを取り込む',
        keywords: ['web', 'url', 'リンク', '取り込み', '取込', 'インポート', '抽出', '海外サイト', '日本サイト', '手順抽出', '翻訳'],
        views: ['list', 'create'],
        steps: [
            'レシピ一覧のメニューで「Webから追加」を押します。',
            'URLを入力して取り込みを実行します。',
            'URL先の本文からタイトル・材料・手順を抽出し、作成フォームに反映します。',
            '抽出結果が日本語以外の場合は、翻訳して取り込むか原文のまま取り込むかを選びます。',
            '取り込み結果を確認し、必要なら材料・手順・分量を修正します。',
            '保存してレシピ登録します。'
        ],
        notes: '日本サイト/海外サイトのどちらも対象ですが、サイト構造や表示方式で精度差があります。保存前に必ず内容確認してください。'
    },
    {
        id: 'recipe_create_image_import',
        title: '画像からレシピを取り込む',
        keywords: ['画像', '写真', 'ocr', 'スキャン', '読み取り', '取り込み', '画像解析', '手書き', 'gemini', 'groq', 'best effort'],
        views: ['list', 'create'],
        steps: [
            'レシピ一覧のメニューで「画像から追加」を押します。',
            '解析エンジンを選択します（通常は「Groq優先」、手書きは「手書き（Gemini）」を試す）。',
            '画像を選択またはドラッグ&ドロップし、解析を実行します。',
            '抽出されたタイトル・材料・手順を確認します。',
            '不足や誤りを修正して保存します。'
        ],
        notes: '手書きや低解像度画像は誤認識が増えます。文字が小さい・表が細かい・情報が密集した画像は抽出しづらいので、トリミングして文字を大きくすると改善しやすいです。'
    },
    {
        id: 'recipe_create_url_import_limit_and_request',
        title: 'URL取り込みできないサイトの対処',
        keywords: ['url取り込みできない', '抽出できない', '失敗', '403', 'プロテクト', '保護', 'cloudflare', '会員サイト', 'ログイン必須', '管理者に申請', 'サイト対応'],
        views: ['list', 'create'],
        steps: [
            'まずURLがブラウザで正常に開けるか確認します（入力ミスや短縮URLミスを除外）。',
            '会員ログイン必須・アクセス制限・ボット対策が強いサイトは抽出失敗することがあります。',
            'エラーが出る場合は、URLを変えて再試行し、抽出可否を確認します。',
            '継続的に同じサイトから取り込みたい場合は、管理者へ対象URLを申請します。',
            '管理者側でそのサイト構造に合わせて抽出ロジックを調整すると、取り込めるように改善できる場合があります。'
        ],
        notes: 'URL取り込みは全サイト100%対応ではありません。プロテクトや動的構成で抽出できないケースがあります。'
    },
    {
        id: 'recipe_create_image_import_accuracy_tips',
        title: '画像解析の精度を上げるコツ',
        keywords: ['画像解析', '精度', '手書き', '細かい', '読めない', '文字が小さい', 'トリミング', 'タイムアウト', 'gemini', 'groq'],
        views: ['list', 'create'],
        steps: [
            'ピントの合った画像を使い、レシピ本文だけが見えるようにトリミングします。',
            '文字が小さい場合は拡大して撮り直すか、ページを分割して複数回に分けて解析します。',
            '通常は「Groq優先」、手書きや崩し字が多い場合は「手書き（Gemini）」を使います。',
            '解析結果は必ず材料名・数量・単位・手順の順に確認してから保存します。'
        ],
        notes: '手書きで細かい構成（段組み・注釈多め・文字詰め）は抽出しづらく、誤認識が出やすいです。'
    },
    {
        id: 'recipe_create_input_requirements',
        title: '新規/編集で入力が期待される項目',
        keywords: ['新規入力', '編集入力', '必須', '何を入力', '入力項目', 'タイトル', '分量', '材料', '手順', 'sourceurl', '保存要件'],
        views: ['create', 'edit'],
        steps: [
            '必須はタイトルです。未入力だと保存できません。',
            '推奨入力は、コース・カテゴリー・店舗名・分量・説明・画像・引用元URLです。',
            '材料は「材料名 / 分量 / 単位 / 仕入れ / 原価」を埋めるほど原価精度が上がります。',
            '手順は作業順で入力し、必要ならグループ化して見やすくします。',
            '保存時にタグはコース・カテゴリー等から自動補完されます。'
        ],
        notes: '編集時も同じ入力項目で更新できます。未保存で戻ると内容は消えるため、区切りごとに保存する運用が安全です。'
    },
    {
        id: 'recipe_create_ingredient_entry_master',
        title: '材料入力で原価計算を正しく合わせる（🧮原価計算アシスト）',
        keywords: ['材料入力', '原価計算', '原価計算アシスト', '🧮', '仕入れ', '内容量', '単位', 'kg', 'g', '候補', 'マスター', 'この容量を保存', '直接入力'],
        views: ['create', 'edit'],
        steps: [
            '材料名は候補（📦マスター / 💰CSV）から選ぶか、直接入力します。',
            '仕入れ欄の右側にある「🧮」を押すと原価計算アシストが開きます。',
            '「仕入れ値」「内容量」「単位」を入力し、必要なら「この容量を保存する」をONにします。',
            '反映すると、仕入れ単価が換算され、分量に応じた原価が自動再計算されます。',
            '保存した容量/単位は次回以降の材料候補や換算に再利用されます。'
        ],
        notes: '例: 1000円/kgの材料をg運用に合わせたい場合は、仕入れ値1000・内容量1000・単位gで保存します。これで100g入力時は100円前後に正しく換算されます。'
    },
    {
        id: 'recipe_edit',
        title: '既存レシピを編集する',
        keywords: ['編集', '修正', '変更', 'update', '編集画面', '反映', '保存', 'URL取り込みはどこ', '画像解析はどこ'],
        views: ['detail', 'edit'],
        steps: [
            'レシピ一覧から対象レシピを開きます。',
            '詳細画面の編集ボタンを押します。',
            'タイトル・材料・手順・説明・画像など必要項目を修正します。',
            '「レシピを保存」で更新します。',
            '一覧に戻って反映を確認します。'
        ],
        notes: '編集画面では新規時の「URL取り込み / 画像解析」カードは表示されません（コード上、新規作成時のみ表示）。既存レシピに取り込み結果を使いたい場合は、手動で転記するか新規作成から取り込みます。'
    },
    {
        id: 'recipe_delete_restore',
        title: 'レシピを削除・復元する',
        keywords: ['削除', '復元', 'ゴミ箱', 'trash', '完全削除'],
        views: ['list', 'trash', 'detail'],
        steps: [
            '通常削除: レシピ詳細または一覧で削除すると、レシピはゴミ箱へ移動します。',
            '復元: トップ画面で ☰ メニューを開き「ゴミ箱」を押し、対象レシピを開いて「復元する」を押します。',
            '完全削除（1件）: ☰ メニュー→「ゴミ箱」→対象レシピ→「完全に削除」→確認ダイアログで確定します。',
            '完全削除（複数）: ゴミ箱一覧で「一括操作」を開始し、対象を選択して「完全削除」を実行します。'
        ],
        notes: '削除直後でも、完全削除していなければゴミ箱から復元できます。完全削除は取り消せません。'
    },
    {
        id: 'recipe_search_filter',
        title: 'レシピを検索・絞り込みする',
        keywords: ['検索', '絞り込み', 'フィルタ', 'タグ', 'コース', 'カテゴリー', '店舗', '通常', '全表示', '自分公開中', '他ユーザー公開', '公開非表示'],
        views: ['list'],
        steps: [
            '一覧上部の検索欄にキーワードを入力します。',
            '店舗・コース・カテゴリーのプルダウンで条件を選びます。',
            '必要なら「通常/全表示」を切り替えて表示を確認します。',
            '公開レシピを見たい場合は「🟢 自分公開中」または「🌐 他ユーザー公開」を押します。',
            '公開一覧を閉じるときは「✕ 公開非表示」を押します。'
        ],
        notes: '条件が多いと0件表示になりやすいので、結果が出ないときは条件を1つずつ外して確認します。'
    },
    {
        id: 'recipe_list_reorder',
        title: 'レシピ一覧の順番を並び替える',
        keywords: ['並び替え', '順番', 'ドラッグ', 'ドロップ', '移動', 'ソート'],
        views: ['list'],
        steps: [
            'レシピ一覧（通常表示）を開きます。',
            '並び替えたいレシピカードを長押し/ドラッグして、目的位置へ移動します。',
            'ドロップすると画面上の順番が更新され、並び順が保存されます。',
            '検索中・絞り込み中・ゴミ箱表示中は並び替え対象外です。'
        ],
        notes: '一覧が意図どおり並ばない場合は、検索/フィルタを解除してから並び替えてください。'
    },
    {
        id: 'recipe_list_recent_recipes',
        title: '最近見たレシピを使って開き直す',
        keywords: ['最近見た', '履歴', 'recent', '開いたレシピ', '見直し'],
        views: ['list', 'detail'],
        steps: [
            'レシピ一覧の最近見たエリアを確認します。',
            '再度見たいレシピを押すと、詳細画面をすぐ開けます。',
            '詳細を開くたびに履歴が更新されるため、よく使うレシピへ短時間で戻れます。'
        ],
        notes: '作業中のレシピを往復する用途で有効です。'
    },
    {
        id: 'recipe_detail_translate_language',
        title: 'レシピ詳細をフランス語などに翻訳する',
        keywords: ['翻訳', 'フランス語', '英語', 'イタリア語', 'スペイン語', '中国語', '言語', 'language', 'original', '原文表示'],
        views: ['detail', 'list'],
        steps: [
            'レシピ一覧で対象レシピを開き、レシピ詳細画面を表示します。',
            '画面上部の言語プルダウン（初期値: 「📄 Original (原文)」）を開きます。',
            '「🇫🇷 French」を選択します（他言語も同じ手順です）。',
            '翻訳が完了すると、タイトル・材料・手順が選択言語で表示されます。',
            '原文も見たい場合は「原文表示」のチェックをONにします。'
        ],
        notes: '翻訳に失敗した場合は自動で原文表示に戻ることがあります。'
    },
    {
        id: 'recipe_detail_print_preview',
        title: 'レシピ詳細を印刷・プレビューする',
        keywords: ['印刷', 'プレビュー', 'print', 'pdf', '帳票', '出力', 'スマホ', 'タブレット', '調理中', '材料タップ', '再計算', '倍率', '仕上がり総重量'],
        views: ['detail'],
        steps: [
            'レシピ詳細画面を開きます。',
            '上部の「🖨️ プレビュー」を押すと、調理中に見やすい専用プレビューが開きます（スマホ/タブレット利用を想定）。',
            'プレビュー内では材料行をタップすると取り消し線と背景変化で「投入済み」を視覚的に管理できます（再タップで解除）。',
            '通常レシピは「分量倍率 ×」、パンレシピは「仕上がり総重量(g)」を入力すると、材料量が自動再計算されます。',
            '翻訳と併用する場合は先に言語を切り替えてからプレビューを開きます。外国人スタッフ向けに各言語表示で確認できます。',
            '上部の「🖨️ 印刷」またはプレビュー内の「🖨️ 印刷する」を押すと印刷ダイアログが開きます。',
            '印刷ダイアログで実プリンター出力か「PDF保存」を選択します。運用記録として残す場合はPDF保存が便利です。'
        ],
        notes: '内容が切れる場合は印刷ダイアログで縮小率・余白を調整してください。PDF保存は端末にデータとして残せます。'
    },
    {
        id: 'recipe_detail_duplicate',
        title: 'レシピを複製する',
        keywords: ['複製', 'コピー', 'duplicate', '同じレシピを作る'],
        views: ['detail'],
        steps: [
            'レシピ詳細画面を開きます。',
            '上部アクションの「複製」を押します。',
            '確認ダイアログで「複製する」を押します。',
            '新しいレシピとして一覧に追加されることを確認します。'
        ],
        notes: '複製後はタイトルや店舗名を編集して区別すると管理しやすくなります。'
    },
    {
        id: 'recipe_detail_edit_delete',
        title: 'レシピ詳細で編集・削除する',
        keywords: ['詳細画面', '編集', '削除', 'update', 'delete'],
        views: ['detail'],
        steps: [
            'レシピ詳細画面を開きます。',
            '修正する場合は「編集」、消す場合は「削除」を押します。',
            '削除時は確認ダイアログで確定します（通常はゴミ箱へ移動）。',
            '必要ならゴミ箱画面で復元または完全削除を行います。'
        ],
        notes: '完全削除は取り消せません。'
    },
    {
        id: 'recipe_detail_top_tabs_overview',
        title: 'レシピ詳細の上部タブを使い分ける',
        keywords: [
            'レシピ表示画面',
            '上部タブ',
            '非公開',
            '公開中',
            'original',
            '原文',
            '原文表示',
            'プレビュー',
            '印刷',
            '複製',
            '編集',
            '削除',
            '復元',
            '完全削除',
            'ゴミ箱',
        ],
        views: ['detail', 'list', 'trash'],
        steps: [
            'レシピ詳細上部には「公開中/非公開」「📄 Original (原文)」「原文表示」「🖨️ プレビュー」「🖨️ 印刷」「複製」「編集」「削除」があります。',
            '「公開中/非公開」は共有設定の切替です。公開にすると公開一覧に表示され、非公開に戻すと公開一覧から外れます。',
            '「📄 Original (原文)」は表示言語の切替です。French などを選ぶと翻訳表示になり、「原文表示」をONにすると原文も併記できます。',
            '「🖨️ プレビュー」は印刷前の確認画面を開き、「🖨️ 印刷」はブラウザ印刷を直接開きます（PDF保存も可能）。',
            '「複製」は現在内容のコピーを新規レシピとして作成します。',
            '「編集」はそのレシピを編集画面で更新する入口です。',
            '「削除」はゴミ箱移動です。削除後でもトップ画面の ☰ スライダー内「ゴミ箱」から復元できます。',
            '完全に消すときは、☰ スライダー→「ゴミ箱」→対象レシピ→「完全に削除」→確認で確定します（この操作は取り消せません）。'
        ],
        notes: '削除と完全削除は別操作です。復元可能な状態を残したい場合は、通常の「削除」で止めてください。'
    },
    {
        id: 'recipe_detail_qr_source',
        title: 'レシピ詳細で元URLをQR表示する',
        keywords: ['qr', 'qrコード', '元レシピ', 'source url', 'スマホで開く', 'リンクを開く'],
        views: ['detail'],
        steps: [
            'レシピ詳細で元URLが登録されているレシピを開きます。',
            'QR表示ボタンを押すとモーダルにQRコードが表示されます。',
            'スマホで読み取ると、元レシピURLを直接開けます。'
        ],
        notes: '元URL未登録のレシピではQR表示できません。'
    },
    {
        id: 'recipe_share_public',
        title: '自分のレシピを公開・非公開する',
        keywords: ['共有', '公開', '公開中', '非公開', '他ユーザー公開', '自分公開中', 'share', 'public', 'private', '見えない', '表示されない', '他のユーザーに見える', 'プライベート'],
        views: ['list', 'detail'],
        steps: [
            'レシピ一覧で対象レシピを開き、レシピ詳細画面を表示します。',
            '画面上部の公開スイッチ（表示: 「公開中」または「非公開」）を確認します。',
            '他ユーザーに公開したい場合は、公開スイッチをONにして「公開中」にします。',
            '一覧へ戻って「🟢 自分公開中」を押し、自分の公開レシピとして表示されることを確認します。',
            '他ユーザー側では一覧の「🌐 他ユーザー公開」に表示されます。',
            '公開をやめたい場合は、同じレシピ詳細で公開スイッチをOFFにして「非公開」に戻します。',
            '非公開に戻した後は、公開一覧（自分公開中/他ユーザー公開）から外れることを確認します。',
            '重要: 自分で共有・公開設定しない限り、そのレシピは他のユーザーには見えません。'
        ],
        notes: '自分の共有・公開にしない限り他ユーザーには見えない運用です。公開スイッチは権限により表示されない場合があります。'
    },
    {
        id: 'recipe_share_public_toggle_visibility',
        title: '公開スイッチが見えない時の確認',
        keywords: ['公開スイッチ見えない', '公開ボタンがない', '非公開しかない', '共有できない', '権限', '閲覧のみ', 'マスターデータ'],
        views: ['detail', 'list'],
        steps: [
            '対象レシピ詳細を開き、上部に「🔒 マスターデータ（閲覧のみ）」表示があるか確認します。',
            '閲覧のみ表示がある場合、そのレシピは編集/削除/公開切替ができません。',
            '公開スイッチは権限があるアカウントでのみ表示されます。',
            '公開設定が必要な場合は、編集権限を持つユーザーで操作するか、運用管理者に依頼します。'
        ],
        notes: '現在の実装では公開スイッチの表示条件が厳格です。見えない場合は不具合より権限制御の可能性が高いです。'
    },
    {
        id: 'voice_input_recipe_form',
        title: 'レシピ作成画面で音声入力を使う',
        keywords: ['音声', 'マイク', 'voice', 'avalon', '話す', '音声入力'],
        views: ['create', 'edit', 'list'],
        steps: [
            'レシピ作成または編集画面を開きます。',
            '入力欄の近くにある「🎤」ボタンを押します。',
            'ブラウザのマイク権限を「許可」にします。',
            '話して停止すると、認識テキストが入力欄に反映されます。'
        ],
        notes: '音声入力が無効な場合は、管理者がデータ管理画面で機能を有効化する必要があります。'
    },
    {
        id: 'voice_toggle_admin',
        title: '音声入力機能を有効/無効にする（管理者）',
        keywords: ['音声入力を有効', '音声入力を無効', 'avalon api', '管理者', 'スイッチ'],
        views: ['data', 'data-management'],
        steps: [
            'データ管理画面を開きます。',
            '価格データタブ上部の「🎤 音声入力（Avalon API）」カードを確認します。',
            'スイッチをON/OFFして保存反映を確認します。'
        ],
        notes: 'この操作は管理者のみ実行できます。'
    },
    {
        id: 'data_price_csv_upload',
        title: '価格データCSVをアップロードする',
        keywords: ['csv', '価格データ', 'アップロード', '仕入れcsv', 'ファイル操作'],
        views: ['data', 'data-management'],
        steps: [
            'メニューから「データ管理」を開き、価格データタブを表示します。',
            '左側の「ファイル操作」カードを開きます。',
            'CSVを選択するか、カードへドラッグ&ドロップします。',
            '「アップロード実行」を押します。',
            '完了メッセージを確認します。'
        ],
        notes: '拡張子は `.csv` を使用してください。'
    },
    {
        id: 'data_price_informart_extract',
        title: 'インフォマートから価格データを抽出して取り込む',
        keywords: [
            'インフォマート',
            'informart',
            'btoBプラットフォーム',
            '受発注',
            '価格データ',
            '抽出',
            'ダウンロード',
            '落とす',
            '取り込み',
            'アップロード',
            '価格データを抽出',
            '取引ダウンロード',
            'ダウンロード依頼',
            '外部データ接続',
            'fim標準',
            '取引明細',
            '受信',
            'csv取込',
            '未登録',
            '登録済み',
            '反映されない',
            '容量',
            '単位',
            '参考価格',
            '区分',
            '価格',
            'キロ',
            'グラム',
            'kg',
            'g'
        ],
        views: ['list', 'data', 'data-management'],
        steps: [
            'インフォマートで「設定・登録」タブを開き、「外部データ接続」を選択します。',
            '「ダウンロード依頼」を開きます。',
            '選択明細は「FIM標準 取引明細」を選択します。',
            '対象期間で月初から月末までを指定します（毎月のデータを積み重ねるときに、期間のダブりを避けやすく管理しやすいため）。',
            '「ダウンロード依頼」ボタンを押します。',
            '次に「ダウンロード一覧」を開き、作成した依頼が出るまで待ちます。',
            'ステータスが受信可能になったら「受信」を押してCSVを取得します。',
            'レシピ管理アプリの「データ管理 > ファイル操作」を開きます。',
            '受信したCSV（FIM標準）をそのまま選択またはドラッグ&ドロップして「アップロード実行」を押します。',
            '続けて「データ管理 > CSV取込」タブを開き、「すべて / 未登録 / 登録済み」を確認します。',
            '未登録が1件以上ある場合は、その行を更新します（特に「容量」と「単位」は必須）。',
            '容量・単位を整備して未登録を減らすと、材料入力候補や原価計算へ正しく反映されます。'
        ],
        notes: '依頼作成直後は受信できないため、数分待ってからダウンロード一覧を更新してください。例: ベルギーエシャロットが 1300円/kg のままでは、レシピ側で 100g 入力時に過大計算になります。CSV取込で容量を 1000、単位を g に整備しておくと、100g 入力時に正しい単価換算（120〜130円前後）で計算されます。'
    },
    {
        id: 'data_price_month_range_reason',
        title: '月初から月末を指定する理由（価格データ）',
        keywords: ['月初', '月末', '理由', 'なぜ', '期間', 'ダブる', '重複', '毎月', '積み重ね', 'インフォマート'],
        views: ['list', 'data', 'data-management'],
        steps: [
            '月初から月末で区切ると、毎月のデータを積み重ねる際に期間の重複（ダブり）を避けやすく、管理がわかりやすくなるためです。'
        ],
        notes: ''
    },
    {
        id: 'data_price_csv_manage',
        title: '保存済み価格CSVを削除・管理する',
        keywords: ['保存済みファイル', 'ファイル削除', 'csv削除', '価格csv'],
        views: ['data', 'data-management'],
        steps: [
            'データ管理 > 価格データタブを開きます。',
            '「保存済みファイル」一覧から対象を探します。',
            '削除ボタンを押して確認ダイアログで確定します。'
        ],
        notes: '必要なら先にバックアップを作成してください。'
    },
    {
        id: 'data_csv_import_tab',
        title: 'CSV取込タブで材料マスター連携を行う',
        keywords: [
            'csv取込',
            '材料マスター',
            '取込タブ',
            'インポート',
            '未登録',
            '登録済み',
            'すべて',
            '容量',
            '単位',
            '参考価格',
            '区分',
            '価格',
            'kg',
            'g',
            'キロ',
            'グラム',
            '反映されない',
            '区分',
            '備品',
            'アルコール',
            'ソフトドリンク',
            '食材',
            '税率',
            '8%',
            '10%'
        ],
        views: ['data', 'data-management', 'csv-import'],
        steps: [
            'データ管理画面を開きます。',
            '上部タブで「CSV取込」を選択します。',
            '「すべて / 未登録 / 登録済み」を切り替え、まず未登録件数を確認します。',
            '未登録が1件以上ある場合は必ず登録を進め、未登録ゼロになるまで更新します。',
            '未登録行では「区分」の設定を最優先で行います（食材 / ソフトドリンク / アルコール / 備品）。',
            '区分設定後に「容量」「単位」「参考価格」などを整備します。',
            '特に重量系は単位換算を合わせます（例: 1300円/kg の材料は容量 1000・単位 g を設定）。',
            '更新後に未登録が解消されたことを確認すると、材料入力候補と原価計算へ正しく反映されます。'
        ],
        notes: '価格CSVアップロードとは別タブです。CSVを入れただけでは未登録の材料情報が残る場合があります。特に区分は税制計算に直結するため必須です（一般運用: 食材・ソフトドリンクは8%、アルコール・備品は10%）。区分未設定のままでは材料原価の税率計算が不正確になります。'
    },
    {
        id: 'data_csv_import_unit_reason',
        title: 'CSV取込で容量と単位を設定する理由',
        keywords: [
            '容量と単位',
            'なぜ必要',
            '理由',
            '未登録',
            'kg',
            'g',
            'キロ',
            'グラム',
            '換算',
            '原価計算',
            '参考価格'
        ],
        views: ['data', 'data-management', 'csv-import', 'create', 'edit', 'detail'],
        steps: [
            'CSV取込で容量と単位を設定する目的は、レシピ入力単位と仕入れ単位を一致させて正しい換算を行うためです。',
            '例: 1300円/kg の材料を g 運用で使うなら、容量 1000・単位 g に整備します。',
            'この整備をしないと、100g 入力時に kg単価のまま過大計算されるリスクがあります。',
            '容量と単位を整備すれば、100g 入力時は正しい単価換算（120〜130円前後）になり、原価が安定します。'
        ],
        notes: ''
    },
    {
        id: 'data_csv_import_category_tax_reason',
        title: 'CSV取込で区分設定が最重要な理由（税率）',
        keywords: [
            'csv取込',
            '未登録',
            '区分',
            '税率',
            '税制',
            '食材',
            'ソフトドリンク',
            'アルコール',
            '備品',
            '8%',
            '10%',
            'なぜ必要',
            '最重要'
        ],
        views: ['data', 'data-management', 'csv-import', 'create', 'edit', 'detail'],
        steps: [
            '新規CSV取り込み後に未登録がある場合は、必ずCSV取込タブで登録し、未登録ゼロまで処理します。',
            '未登録行の中で最重要項目は「区分」です（食材 / ソフトドリンク / アルコール / 備品）。',
            '区分を設定する理由は税率が異なるためです（一般運用: 食材・ソフトドリンク8%、アルコール・備品10%）。',
            'レシピの材料原価計算では、区分に応じた税率が使われるため、区分未設定だと税計算がずれます。',
            '区分設定後に容量・単位も整備して保存すると、材料候補表示と原価計算が安定します。'
        ],
        notes: '未登録を残さず区分を必ず設定することが、税率計算と原価精度の前提です。'
    },
    {
        id: 'data_ingredient_master',
        title: '材料マスターを編集する',
        keywords: ['材料マスター', '単位', '仕入れ値', '業者', 'マスター編集'],
        views: ['data', 'data-management', 'ingredients'],
        steps: [
            'データ管理画面を開きます。',
            '「材料マスター」タブを選択します。',
            '対象行を編集して内容量・単位・価格・業者などを更新します。',
            '必要に応じてCSV単位上書きも設定します。'
        ],
        notes: ''
    },
    {
        id: 'data_duplicates',
        title: '重複アイテムの価格履歴を確認する',
        keywords: [
            '重複',
            '重複アイテム',
            '価格履歴',
            'dup',
            '履歴',
            '入荷履歴',
            '価格変動',
            '玉ねぎ',
            'いつ入荷',
            '日付',
            '最終納品',
            '最新価格',
            '自動反映'
        ],
        views: ['data', 'data-management', 'duplicates'],
        steps: [
            'データ管理画面で「重複アイテム」タブを開きます。',
            '左一覧から材料を選択します（例: 玉ねぎ）。',
            'これまで取り込んだFIM標準CSVの入荷データを、日付つきで時系列に確認します。',
            'どの時期にどれくらい入荷したか、価格がどう変動したかを比較します。',
            '表示結果を参考に、材料マスターや運用単価の見直し判断に使います。'
        ],
        notes: 'この画面は月次だけを見る用途ではなく、これまでの入荷履歴を総合的に確認するための画面です。なお、レシピ側で参照される価格は基本的に最終納品（最新）価格が自動反映されます。'
    },
    {
        id: 'data_backup_management',
        title: 'バックアップ管理を使う（管理者）',
        keywords: ['バックアップ管理', 'backup management', 'cron', '復元', '出力'],
        views: ['data', 'data-management', 'backup-management'],
        steps: [
            '管理者でデータ管理画面を開きます。',
            '「バックアップ管理」タブを開きます。',
            '必要なバックアップ作成・復元・確認操作を実行します。'
        ],
        notes: '権限がない場合は表示されません。'
    },
    {
        id: 'data_management_tabs_overview_non_admin',
        title: 'データ管理の主要タブを使い分ける（非管理者向け）',
        keywords: [
            'データ管理',
            '各タブ',
            '価格データ',
            '材料マスター',
            'csv取込',
            '重複アイテム',
            'ゴミ箱',
            'どこを見る',
            '使い分け',
            '重要'
        ],
        views: ['data', 'data-management', 'csv-import', 'duplicates', 'trash'],
        steps: [
            '価格データ: FIM標準CSVのアップロード、保存済みファイル管理、登録データ一覧の確認を行う入口です。',
            '材料マスター: 内容量・単位・仕入れ値・歩留まり・区分を整備し、原価計算の基準を作るタブです。',
            'CSV取込: 未登録品を登録し、特に区分・容量・単位を補完して計算ズレを防ぐタブです。',
            '重複アイテム: 入荷履歴を時系列で見て、価格変動・入荷量・日付を比較する分析タブです。',
            'ゴミ箱: 価格CSVと材料マスターの削除データを復元/完全削除するタブです。'
        ],
        notes: 'データ管理は原価計算・材料候補表示・在庫/発注計算の土台です。ここが未整備だと下流の表示や計算が連鎖的にずれます。'
    },
    {
        id: 'data_management_tab_price_data_non_admin',
        title: '価格データタブの詳細（非管理者向け）',
        keywords: [
            '価格データ',
            '仕入れcsv',
            'ファイル操作',
            'アップロード実行',
            '登録データ一覧',
            '保存済みファイル',
            '検索',
            '並び替え',
            'ゴミ箱へ移動'
        ],
        views: ['data', 'data-management'],
        steps: [
            '「ファイル操作」でFIM標準CSVを選択またはドラッグ&ドロップし、「アップロード実行」を押します。',
            'アップロード後、「登録データ一覧」で納品日・業者名・材料名・単価を検索/並び替えで確認します。',
            '「保存済みファイル」で取り込んだCSVの一覧確認と個別削除ができます。',
            '必要に応じて「全件ゴミ箱へ移動」を使い、価格CSVをまとめて退避できます。'
        ],
        notes: '新しいCSVは既存データとマージされ、運用上は新しい納品日のデータが優先されます。'
    },
    {
        id: 'data_management_tab_ingredient_master_non_admin',
        title: '材料マスタータブの詳細（非管理者向け）',
        keywords: [
            '材料マスター',
            '内容量',
            '単位',
            '仕入れ値',
            '歩留まり',
            '区分',
            '食材',
            'アルコール',
            'ソフトドリンク',
            '備品',
            '元の単位',
            '換算単価',
            '新規材料'
        ],
        views: ['data', 'data-management', 'ingredients'],
        steps: [
            '材料マスターでは、材料名・内容量・単位・仕入れ値・業者・歩留まり・区分を整備します。',
            '区分タブ（食材 / アルコール / ソフトドリンク / 備品 / 手入力）で対象を絞って編集します。',
            '元の単位（CSV）と換算単価を確認し、レシピ入力単位と仕入れ単位のズレを補正します。',
            '必要なら「+ 新規材料」で追加し、保存後にレシピ側の材料候補と原価計算へ反映させます。'
        ],
        notes: '区分は税率計算、内容量・単位は単価換算、歩留まりは可食率補正に直結するため、ここが最重要基準データです。'
    },
    {
        id: 'data_management_tab_csv_import_non_admin',
        title: 'CSV取込タブの詳細（非管理者向け）',
        keywords: [
            'csv取込',
            '未登録',
            '登録済み',
            '全て',
            '参考価格',
            '区分',
            '容量',
            '単位',
            '価格',
            '登録',
            '更新',
            '一括登録'
        ],
        views: ['data', 'data-management', 'csv-import'],
        steps: [
            'CSV取込タブを開き、まず「未登録」の件数を確認します。',
            '未登録がある場合は、区分・容量・単位・価格を埋めて「登録/更新」します。',
            '件数が多い場合は編集後に「変更を一括登録」でまとめて反映します。',
            '未登録をゼロまで減らすことで、材料候補表示と原価計算の精度が安定します。'
        ],
        notes: '未登録を放置すると、材料名は見えても換算や税率計算が不正確になり、レシピ原価が崩れます。'
    },
    {
        id: 'data_management_tab_duplicates_non_admin',
        title: '重複アイテムタブの詳細（非管理者向け）',
        keywords: [
            '重複アイテム',
            '価格履歴',
            '入荷履歴',
            '時系列',
            '納品日',
            '入荷数',
            '単価',
            '入荷金額',
            '前回比',
            '全期間',
            '月フィルタ'
        ],
        views: ['data', 'data-management', 'duplicates'],
        steps: [
            '左の重複一覧から材料を選ぶと、右側に履歴テーブルが表示されます。',
            '履歴では納品日・業者名・材料名・入荷数・単価・入荷金額・前回比を確認できます。',
            '全期間表示と月フィルタを切り替え、価格変動と入荷傾向を比較します。',
            '合計入荷量/合計金額を見ながら、単価見直しや仕入れ判断の参考にします。'
        ],
        notes: 'このタブは「過去履歴の分析」が目的です。直近価格だけでなく推移全体を見て判断します。'
    },
    {
        id: 'data_management_tab_trash_non_admin',
        title: 'ゴミ箱タブの詳細（非管理者向け）',
        keywords: [
            'ゴミ箱',
            '価格データcsv',
            '材料マスター',
            '復元',
            '完全削除',
            '削除日時',
            '選択',
            '全件'
        ],
        views: ['data', 'data-management', 'trash'],
        steps: [
            'ゴミ箱タブでは「価格データCSV」と「材料マスター」の削除済みデータを別々に管理します。',
            'チェック選択して復元すると、元の運用データへ戻せます。',
            '完全削除は取り消し不可なので、対象と件数を確認してから実行します。',
            '削除日時を見て、いつ退避したデータかを確認してから判断します。'
        ],
        notes: '誤削除時の復旧入口がゴミ箱です。普段の運用では「まず復元可能な削除」を使い、完全削除は最後に行うのが安全です。'
    },
    {
        id: 'inventory_basic',
        title: '在庫管理の基本操作',
        keywords: ['在庫管理', '棚卸', 'inventory', '在庫'],
        views: ['inventory', 'list'],
        steps: [
            'メニューから「在庫管理」を開きます。',
            '棚卸し対象の項目を確認・更新します。',
            '必要に応じてスナップショット保存や集計を実行します。'
        ],
        notes: '月次集計や業者別集計は在庫管理画面内で確認できます。'
    },
    {
        id: 'incoming_deliveries_pdf',
        title: '入荷PDFを解析して保存する',
        keywords: ['入荷pdf', 'pdf', '解析', '伝票', 'ドロップ'],
        views: ['incoming-deliveries', 'list'],
        steps: [
            'メニューから「入荷PDF」を開きます。',
            'PDFを選択またはドラッグ&ドロップします。',
            '「解析する」を押して内容を確認します。',
            '問題なければ「保存する」で登録します。'
        ],
        notes: ''
    },
    {
        id: 'incoming_stock_apply',
        title: '入荷在庫を在庫へ反映する',
        keywords: ['入荷在庫', '反映', '消費', '適用', 'incoming stock'],
        views: ['incoming-stock', 'list'],
        steps: [
            'メニューから「入荷在庫」を開きます。',
            '反映対象の入荷データを選択します。',
            '必要なら数量を調整し、在庫反映を実行します。',
            '完了後に在庫管理画面で反映結果を確認します。'
        ],
        notes: ''
    },
    {
        id: 'planner_basic',
        title: '仕込みカレンダーを使う',
        keywords: ['仕込み', 'カレンダー', 'planner', '予定'],
        views: ['planner', 'list'],
        steps: [
            'メニューから「仕込みカレンダー」を開きます。',
            '日付を選んで仕込み予定を登録・編集します。',
            '必要に応じてレシピ詳細や発注リストへ遷移します。'
        ],
        notes: ''
    },
    {
        id: 'planner_detailed_operations_non_admin',
        title: '仕込みカレンダーの詳細操作（非管理者向け）',
        keywords: [
            '仕込みカレンダー',
            '操作方法',
            '使い方',
            'ドラッグ',
            'ドロップ',
            'レシピ検索',
            '倍率',
            '総量',
            'パン',
            '移動',
            '削除',
            '一括削除'
        ],
        views: ['planner'],
        steps: [
            '左のレシピ一覧で検索し、対象レシピを日付セルへドラッグ&ドロップして予定を追加します。',
            '通常レシピは「倍率」、パンレシピは「総量(g)」を入力して確定します。',
            '登録済み予定は別日へドラッグして移動できます（同日ドロップは変更なし）。',
            '予定カードの「×」で1件削除、上部の「一括削除」で期間指定してまとめて削除できます。',
            '予定カードをクリックするとレシピ詳細へ遷移して内容確認できます。',
            '上部ボタンから「発注リストへ」を押すと、同じ運用のまま発注計算へ進めます。'
        ],
        notes: '仕込み予定は meal_plans に保存され、通信不良時はローカルへ一時保存されるフォールバックがあります。'
    },
    {
        id: 'planner_to_orderlist_effect_non_admin',
        title: '仕込みカレンダーを入れる効果（発注リスト連携）',
        keywords: [
            '仕込みカレンダーの効果',
            '何に効く',
            '発注リスト連携',
            '必要量',
            '残在庫',
            '発注量',
            '在庫差し引き',
            '不足',
            '表示される'
        ],
        views: ['planner', 'order-list', 'inventory'],
        steps: [
            '発注リスト生成時は、指定期間の仕込み予定から材料必要量を合算します。',
            'その必要量に対して在庫数量を差し引き、残在庫と不足分を算出します。',
            '不足が出た材料だけが発注候補として表示されます。',
            '仕込みカレンダーに予定を正しく入れるほど、発注リストの必要量計算が現場実態に近づきます。'
        ],
        notes: 'ここでの在庫差し引きは「発注計算上の差し引き」です。発注リストを作っただけで在庫DB数量を自動減算するわけではありません。'
    },
    {
        id: 'planner_inventory_prerequisite_non_admin',
        title: '仕込み連携で在庫数を先に入れておく重要性',
        keywords: [
            '在庫を先に入れる',
            '在庫数',
            '上限',
            '精度',
            '仕込み',
            '発注',
            '過剰発注',
            '不足判定',
            '初期在庫'
        ],
        views: ['planner', 'order-list', 'inventory', 'data', 'data-management'],
        steps: [
            '在庫管理で各材料の在庫数と単位を先に整備します。',
            '仕込み予定を入れて発注リストを生成すると、在庫を差し引いた不足量で判定されます。',
            '在庫が未入力だと0として扱われやすく、必要以上の発注候補が出る原因になります。',
            '逆に在庫数が入っていれば、どこまで仕込めるか（上限）と不足タイミングが見えるようになります。'
        ],
        notes: '特に単位がずれていると差し引き計算が崩れるため、材料マスター・CSV取込で容量/単位を揃えておくことが前提です。'
    },
    {
        id: 'order_list_calculation_rule_non_admin',
        title: '発注リストの算出ルール（非管理者向け）',
        keywords: [
            '発注リスト',
            '算出ルール',
            '計算ロジック',
            '20%',
            '規格',
            'パック',
            '発注単位',
            '前提'
        ],
        views: ['order-list', 'planner', 'inventory'],
        steps: [
            '必要量は、期間内の仕込み予定に含まれる材料量を倍率/総量を反映して集計します。',
            '在庫は材料マスター基準で単位正規化して差し引き、残在庫を計算します。',
            '規格（内容量）がある材料は「残在庫が1規格の2割未満」で発注対象になります。',
            '規格がない材料は、単純に必要量 > 在庫の差分を発注量として出します。',
            '発注表示の単位は「CSV単位上書き > CSV単位 > 既定」の順で決まります。'
        ],
        notes: '在庫・材料マスター・CSV単位上書きの整備度が、発注推奨の精度を左右します。'
    },
    {
        id: 'order_list_basic',
        title: '発注リストを確認する',
        keywords: ['発注', 'order', '発注リスト'],
        views: ['order-list', 'planner', 'list'],
        steps: [
            'メニューから「発注リスト」を開きます。',
            '必要な材料や数量を確認します。',
            '必要なら仕込みカレンダーと行き来して調整します。'
        ],
        notes: ''
    },
    {
        id: 'user_management_admin',
        title: 'ユーザー管理（管理者）',
        keywords: ['ユーザー管理', 'ユーザー', '権限', 'admin', 'アカウント'],
        views: ['users', 'list'],
        steps: [
            '管理者でメニューから「ユーザー管理」を開きます。',
            '対象ユーザーを選択し、必要な操作（確認・更新）を行います。',
            '保存後に一覧で反映を確認します。'
        ],
        notes: '管理者以外には表示されません。'
    },
    {
        id: 'api_logs_admin',
        title: 'API使用ログを確認する（管理者）',
        keywords: ['api使用ログ', 'apiログ', '利用状況', 'コスト', 'admin'],
        views: ['api-logs', 'list'],
        steps: [
            '管理者でメニューから「API使用ログ」を開きます。',
            '期間やAPI種別を確認して利用状況を把握します。',
            '必要に応じて運用設定を見直します。'
        ],
        notes: '管理者以外には表示されません。'
    },
    {
        id: 'general_navigation',
        title: '目的画面へ移動する',
        keywords: ['どこ', 'どの画面', '見つからない', '移動', '開く'],
        views: ['list', 'data', 'inventory', 'incoming-deliveries', 'incoming-stock', 'planner', 'order-list'],
        steps: [
            '右上メニュー（☰）を開きます。',
            '目的に合う画面（データ管理/在庫管理/入荷PDF/入荷在庫/仕込みカレンダー/発注リスト）を選びます。',
            '見つからない場合は一度「一覧に戻る」後に再度メニューを開きます。'
        ],
        notes: '管理者専用メニューは管理者ログイン時のみ表示されます。'
    },
    {
        id: 'menu_slider_button_guide',
        title: 'スライドメニュー各ボタンの操作内容',
        keywords: [
            'スライダー',
            'スライドメニュー',
            'メニュー',
            'ハンバーガー',
            '☰',
            'q&a',
            'アプリガイド',
            'webから追加',
            '画像から追加',
            '在庫管理',
            '入荷pdf',
            '入荷在庫',
            '仕込みカレンダー',
            '発注リスト',
            'データ管理',
            'ユーザー管理',
            'api使用ログ',
            '一括削除',
            'ゴミ箱',
            '一覧に戻る',
            'ログアウト'
        ],
        views: ['list', 'detail', 'create', 'edit', 'data', 'inventory', 'incoming-deliveries', 'incoming-stock', 'planner', 'order-list', 'trash'],
        steps: [
            '右上の「☰」でメニューを開き、「✕」または背景タップで閉じます。',
            '「Q&A」: 別タブで `recipe.html` を開きます。',
            '「アプリガイド」: 別タブで `recipe_management.pdf` を開きます。',
            '「Webから追加」: URL取り込みモーダルを開きます（一覧画面で表示）。',
            '「画像から追加」: 画像取り込みモーダルを開きます（一覧画面で表示）。',
            '「在庫管理 / 入荷PDF / 入荷在庫 / 仕込みカレンダー / 発注リスト」: 各画面へ遷移します。',
            '「データ管理」: 価格データや材料マスター管理画面へ遷移します。',
            '「ユーザー管理 / API使用ログ」: 管理者のみ表示され、各管理画面へ遷移します。',
            '「一括削除（または一括操作）」: 選択モードを開始します。',
            '「ゴミ箱」: 削除済みレシピ一覧へ遷移します（一覧画面で表示）。',
            '「一覧に戻る」: レシピ一覧画面へ戻ります。',
            '「ログアウト」: サインアウトします。'
        ],
        notes: '一部ボタンは一覧画面でのみ表示されます。管理者専用ボタンは管理者ログイン時のみ表示されます。'
    },
    {
        id: 'general_button_not_working',
        title: 'ボタンが反応しない時の確認',
        keywords: ['押せない', '反応しない', 'クリックできない', '固まる', '進まない', 'error', 'エラー'],
        views: ['list', 'detail', 'create', 'edit', 'data', 'data-management', 'inventory', 'incoming-deliveries', 'incoming-stock', 'planner', 'order-list'],
        steps: [
            '画面を一度再読み込みします（PC: Cmd+Shift+R / Windows: Ctrl+F5）。',
            '同じ画面で再度ボタンを押し、表示されるエラー文を確認します。',
            '入力必須項目が未入力でないか確認します（タイトル・ファイル選択など）。',
            '改善しない場合は「画面名 / ボタン名 / エラー文」を操作AIへ送ってください。'
        ],
        notes: '一時的な通信不良やセッション切れで反応しないことがあります。'
    },
];

const normalize = (value) => {
    return String(value || '')
        .toLowerCase()
        .replace(/[！!？?。、,.:：;；\-_/\\\s(){}「」『』]+/g, '');
};

const uniqueWords = (value) => {
    return Array.from(new Set(String(value || '')
        .toLowerCase()
        .split(/[\s、。,.!！?？:：;；/\\\-_(){}「」『』]+/)
        .map((token) => token.trim())
        .filter(Boolean)));
};

const SYNONYM_GROUPS = [
    ['翻訳', '言語', 'language', '英語', 'フランス語', 'イタリア語', 'スペイン語', '中国語', '原文', 'original'],
    ['csv', 'シーエスブイ', 'ファイル', 'アップロード', 'インポート', '取込', '取り込み', 'ドラッグ', 'ドロップ'],
    ['url取り込み', 'web取り込み', 'webから追加', 'urlから追加', '抽出', 'スクレイピング', 'import'],
    ['url取り込みできない', '抽出できない', '403', 'プロテクト', '保護', 'cloudflare', '会員サイト', 'ログイン必須'],
    ['画像解析', '画像から追加', '写真から追加', 'ocr', '手書き', '読めない', '文字が小さい', 'トリミング', 'gemini', 'groq', 'best effort'],
    ['原価計算アシスト', '電卓', '🧮', '仕入れ', '内容量', 'この容量を保存', '換算', 'kg', 'g'],
    ['インフォマート', 'informart', 'btoBプラットフォーム', '受発注', '外部データ接続', 'ダウンロード依頼', '受信', 'fim標準', '取引明細'],
    ['容量', '単位', '換算', 'kg', 'キロ', 'g', 'グラム', '参考価格', '未登録', '登録済み'],
    ['区分', 'カテゴリー', '備品', 'アルコール', 'ソフトドリンク', '食材', '税率', '8%', '10%'],
    ['月初', '月末', '期間', 'ダブる', '重複', '毎月', '積み重ね'],
    ['重複アイテム', '価格履歴', '入荷履歴', '価格変動', '最終納品', '最新価格', '自動反映'],
    ['データ管理', '価格データ', '材料マスター', 'csv取込', '重複アイテム', 'ゴミ箱', '登録データ一覧', '保存済みファイル'],
    ['仕込みカレンダー', 'planner', '予定', 'ドラッグ', 'ドロップ', '倍率', '総量', '一括削除'],
    ['発注リスト', 'order list', '必要量', '残在庫', '発注量', '不足', '在庫差し引き', '20%', '規格'],
    ['在庫数', '初期在庫', '上限', '過剰発注', '精度'],
    ['メニュー', 'スライダー', 'スライドメニュー', 'ハンバーガー', '☰', 'ナビ'],
    ['音声', 'マイク', 'voice', 'avalon', '話す', 'しゃべる'],
    ['削除', '消す', 'ゴミ箱', '復元', 'restore', 'trash'],
    ['印刷', 'プレビュー', 'print', 'pdf', '出力'],
    ['複製', 'コピー', 'duplicate'],
    ['共有', '公開', '公開中', '非公開', 'share', 'public', 'private', '見えない', '表示されない', 'プライベート'],
    ['検索', '絞り込み', 'フィルタ', 'filter'],
    ['編集', '修正', '変更', 'update'],
    ['並び替え', '順番', 'ドラッグ', 'ドロップ', '移動', 'ソート'],
    ['最近見た', '履歴', 'recent', '再表示', '見直し'],
    ['qr', 'qrコード', '元レシピ', 'sourceurl', 'スマホで開く'],
    ['公開スイッチ見えない', '公開ボタンがない', '共有できない', '閲覧のみ', '権限'],
];

const ENTRY_INTENT_BOOSTS = {
    recipe_detail_translate_language: ['翻訳', '言語', 'フランス語', '英語', 'original'],
    recipe_detail_print_preview: ['印刷', 'プレビュー', 'print', 'pdf'],
    recipe_detail_duplicate: ['複製', 'コピー', 'duplicate'],
    recipe_detail_edit_delete: ['編集', '削除', 'ゴミ箱'],
    recipe_detail_top_tabs_overview: ['上部タブ', '非公開', '公開中', 'original', '原文', 'プレビュー', '印刷', '複製', '編集', '削除', '復元', '完全削除', 'ゴミ箱'],
    recipe_edit: ['編集', '修正', '更新', '反映', '保存', '編集画面'],
    recipe_share_public: ['共有', '公開', '公開中', '非公開', '他ユーザー公開', '自分公開中', '見えない', '表示されない', 'private', 'プライベート'],
    recipe_share_public_toggle_visibility: ['公開スイッチ見えない', '公開ボタンがない', '共有できない', '閲覧のみ', '権限', 'マスターデータ'],
    recipe_detail_qr_source: ['qr', 'qrコード', '元レシピ', 'sourceurl', 'スマホで開く'],
    recipe_create_manual: ['新規作成', '手入力', '必須', '入力項目', 'タイトル', '保存'],
    recipe_create_web_import: ['url', 'web', '取り込み', '抽出', '海外サイト', '日本サイト', '手順抽出', '翻訳'],
    recipe_create_image_import: ['画像解析', '手書き', 'ocr', 'gemini', 'groq', 'best effort'],
    recipe_create_url_import_limit_and_request: ['url取り込みできない', '抽出できない', '403', 'プロテクト', 'cloudflare', '会員サイト', 'ログイン必須', '管理者に申請', 'サイト対応'],
    recipe_create_image_import_accuracy_tips: ['画像解析', '精度', '手書き', '細かい', '文字が小さい', 'トリミング', 'gemini'],
    recipe_create_input_requirements: ['入力項目', '必須', 'タイトル', '保存できない', '何を入力', '新規入力', '編集入力'],
    recipe_create_ingredient_entry_master: ['材料入力', '🧮', '原価計算アシスト', '仕入れ', '内容量', '単位', '換算', 'kg', 'g', 'この容量を保存', 'マスター'],
    data_price_csv_upload: ['csv', 'アップロード', 'ドラッグ', 'ドロップ', 'ファイル操作', 'shiftjis'],
    data_price_informart_extract: ['インフォマート', 'informart', '価格データ', '抽出', 'ダウンロード', '受信', 'fim標準', '取引明細', 'アップロード', '月初', '月末', 'csv取込', '未登録', '容量', '単位', 'kg', 'g'],
    data_price_month_range_reason: ['月初', '月末', '理由', 'なぜ', '期間', 'ダブる', '重複', '毎月', '積み重ね'],
    data_csv_import_tab: ['csv取込', 'インポート', '取込', '未登録', '登録済み', '容量', '単位', 'kg', 'g', '換算', '区分', '税率', '食材', 'ソフトドリンク', 'アルコール', '備品'],
    data_csv_import_unit_reason: ['容量', '単位', 'kg', 'g', '換算', '原価計算', '理由'],
    data_csv_import_category_tax_reason: ['区分', '税率', '食材', 'ソフトドリンク', 'アルコール', '備品', '8%', '10%', '未登録'],
    data_duplicates: ['重複アイテム', '価格履歴', '入荷履歴', '価格変動', '日付', '最終納品', '最新価格', '自動反映'],
    data_management_tabs_overview_non_admin: ['データ管理', '各タブ', '価格データ', '材料マスター', 'csv取込', '重複アイテム', 'ゴミ箱', '使い分け', '重要'],
    data_management_tab_price_data_non_admin: ['価格データ', 'csvアップロード', 'ファイル操作', '登録データ一覧', '保存済みファイル', 'ゴミ箱へ移動'],
    data_management_tab_ingredient_master_non_admin: ['材料マスター', '内容量', '単位', '歩留まり', '区分', '元の単位', '換算単価'],
    data_management_tab_csv_import_non_admin: ['csv取込', '未登録', '登録済み', '区分', '容量', '単位', '一括登録'],
    data_management_tab_duplicates_non_admin: ['重複アイテム', '価格履歴', '入荷履歴', '前回比', '全期間', '月フィルタ'],
    data_management_tab_trash_non_admin: ['ゴミ箱', '復元', '完全削除', '価格データcsv', '材料マスター', '削除日時'],
    planner_detailed_operations_non_admin: ['仕込みカレンダー', 'ドラッグ', 'ドロップ', '倍率', '総量', 'パン', '移動', '一括削除'],
    planner_to_orderlist_effect_non_admin: ['仕込みカレンダーの効果', '発注リスト', '必要量', '残在庫', '不足', '在庫差し引き'],
    planner_inventory_prerequisite_non_admin: ['在庫数', '初期在庫', '上限', '精度', '過剰発注', '在庫を先に'],
    order_list_calculation_rule_non_admin: ['発注リスト', '算出ルール', '20%', '規格', 'パック', '発注単位', '計算ロジック'],
    menu_slider_button_guide: ['メニュー', 'スライダー', 'スライドメニュー', 'ハンバーガー', 'q&a', 'アプリガイド', 'webから追加', '画像から追加', '一括削除', 'ゴミ箱', '一覧に戻る', 'ログアウト'],
    recipe_list_reorder: ['並び替え', '順番', 'ドラッグ', 'ドロップ', '移動', 'ソート'],
    recipe_list_recent_recipes: ['最近見た', '履歴', 'recent', '開き直す'],
    voice_input_recipe_form: ['音声', 'マイク', 'voice', 'avalon'],
    recipe_search_filter: ['検索', '絞り込み', 'フィルタ'],
    general_button_not_working: ['押せない', '反応しない', '固まる', '進まない', 'エラー'],
};

const SYNONYM_LOOKUP = (() => {
    const map = new Map();
    for (const group of SYNONYM_GROUPS) {
        const normalizedGroup = Array.from(new Set(group.map((item) => normalize(item)).filter(Boolean)));
        for (const token of normalizedGroup) {
            const siblings = normalizedGroup.filter((candidate) => candidate !== token);
            const prev = map.get(token) || [];
            map.set(token, Array.from(new Set([...prev, ...siblings])));
        }
    }
    return map;
})();

const expandWithSynonyms = (normalizedWords) => {
    const expanded = new Set((normalizedWords || []).filter(Boolean));
    for (const word of expanded) {
        const aliases = SYNONYM_LOOKUP.get(word) || [];
        aliases.forEach((alias) => expanded.add(alias));
    }
    return Array.from(expanded);
};

const buildGuideOperationKb = () => {
    const guideEntries = Array.isArray(operationGuideKnowledge?.entries) ? operationGuideKnowledge.entries : [];
    return guideEntries
        .map((entry, index) => {
            const steps = Array.isArray(entry?.steps)
                ? entry.steps.map((step) => String(step || '').trim()).filter(Boolean).slice(0, 6)
                : [];
            const fallbackStep = String(entry?.notes || '').trim();
            const normalizedSteps = steps.length > 0
                ? steps
                : (fallbackStep ? [fallbackStep] : []);
            if (normalizedSteps.length === 0) return null;

            return {
                id: String(entry?.id || `guide_dynamic_${index + 1}`),
                title: String(entry?.title || '操作ガイド').trim(),
                keywords: Array.isArray(entry?.keywords)
                    ? entry.keywords.map((word) => String(word || '').trim()).filter(Boolean).slice(0, 24)
                    : [],
                views: Array.isArray(entry?.views)
                    ? entry.views.map((view) => String(view || '').trim()).filter(Boolean)
                    : [],
                steps: normalizedSteps,
                notes: String(entry?.notes || '').trim(),
                source: String(entry?.source || 'guide'),
            };
        })
        .filter(Boolean);
};

const GUIDE_OPERATION_KB = buildGuideOperationKb();

const OPERATION_KB = [
    ...CORE_OPERATION_KB,
    ...GUIDE_OPERATION_KB,
];

const toBigrams = (value) => {
    const text = String(value || '');
    if (!text) return [];
    if (text.length === 1) return [text];
    const grams = [];
    for (let i = 0; i < text.length - 1; i += 1) {
        grams.push(text.slice(i, i + 2));
    }
    return grams;
};

const similarityByBigrams = (left, right) => {
    const leftSet = new Set(toBigrams(normalize(left)));
    const rightSet = new Set(toBigrams(normalize(right)));
    if (leftSet.size === 0 || rightSet.size === 0) return 0;

    let intersection = 0;
    for (const token of leftSet) {
        if (rightSet.has(token)) intersection += 1;
    }
    const union = new Set([...leftSet, ...rightSet]).size;
    if (union === 0) return 0;
    return intersection / union;
};

const scoreEntry = (entry, normalizedQuestion, questionWords, currentView) => {
    let score = 0;
    const matchedKeywords = [];

    for (const keyword of (entry.keywords || [])) {
        const normalizedKeyword = normalize(keyword);
        if (!normalizedKeyword) continue;

        let matched = false;
        if (normalizedQuestion.includes(normalizedKeyword)) {
            score += 5;
            matched = true;
        } else {
            const keywordWords = uniqueWords(keyword)
                .map((word) => normalize(word))
                .filter(Boolean);
            if (keywordWords.some((word) => questionWords.includes(word))) {
                score += 3;
                matched = true;
            }
        }

        if (matched) matchedKeywords.push(keyword);
    }

    const viewMatched = !!entry.views?.includes(currentView);
    if (viewMatched) score += 2;

    const normalizedTitle = normalize(entry.title);
    const titleMatched = normalizedQuestion.includes(normalizedTitle);
    if (titleMatched) score += 4;

    const titleSimilarity = similarityByBigrams(normalizedQuestion, normalizedTitle);
    if (titleSimilarity >= 0.42) {
        score += 5;
    } else if (titleSimilarity >= 0.26) {
        score += 3;
    }

    const intentHints = ENTRY_INTENT_BOOSTS[entry.id] || [];
    for (const hint of intentHints) {
        const normalizedHint = normalize(hint);
        if (!normalizedHint) continue;
        if (normalizedQuestion.includes(normalizedHint) || questionWords.includes(normalizedHint)) {
            score += 2;
        }
    }

    // Avoid selecting a candidate only because the current view matches.
    if (!titleMatched && matchedKeywords.length === 0 && titleSimilarity < 0.2) {
        score = 0;
    }

    if (entry?.source === 'recipe_html' && score > 0) {
        // Keep first-party curated knowledge slightly prioritized.
        score -= 1;
    }

    return {
        score,
        matchedKeywords,
        viewMatched,
        titleMatched,
        titleSimilarity,
    };
};

const rankOperationKnowledge = ({ question, currentView, limit = 3 }) => {
    const normalizedQuestion = normalize(question);
    if (!normalizedQuestion) return [];

    const questionWords = expandWithSynonyms(uniqueWords(question)
        .map((word) => normalize(word))
        .filter(Boolean));

    return OPERATION_KB
        .map((entry) => {
            const scored = scoreEntry(entry, normalizedQuestion, questionWords, currentView);
            return {
                entry,
                ...scored,
            };
        })
        .filter((item) => item.score > 0)
        .sort((a, b) => {
            if (b.score !== a.score) return b.score - a.score;
            if (b.matchedKeywords.length !== a.matchedKeywords.length) {
                return b.matchedKeywords.length - a.matchedKeywords.length;
            }
            return a.entry.title.localeCompare(b.entry.title, 'ja');
        })
        .slice(0, limit);
};

const buildClarificationLines = ({ assessment, currentViewLabel, currentView }) => {
    const optionsByView = {
        detail: [
            '翻訳（言語切替）',
            '共有・公開設定',
            '公開スイッチが見えない時',
            '編集・保存',
            '削除・復元',
            'QRコード（元URL）',
            '印刷・プレビュー',
        ],
        create: [
            '新規作成の入力',
            '必須項目（保存条件）',
            'URL取り込み（Web）',
            '画像解析（AI）',
            '材料入力と原価計算アシスト（🧮）',
            '音声入力（マイク）',
            '保存・登録',
        ],
        edit: [
            '既存内容の修正',
            '必須項目（保存条件）',
            '材料入力と原価計算アシスト（🧮）',
            '音声入力（マイク）',
            '保存・更新',
            '材料・手順の並び替え',
        ],
        data: [
            '価格データ（CSVアップロード）',
            '材料マスター編集',
            'CSV取込（未登録の登録）',
            '重複アイテム（価格履歴確認）',
            'ゴミ箱（復元/完全削除）',
        ],
        'data-management': [
            '価格データ（CSVアップロード）',
            '材料マスター編集',
            'CSV取込（未登録の登録）',
            '重複アイテム（価格履歴確認）',
            'ゴミ箱（復元/完全削除）',
        ],
        inventory: [
            '在庫数の更新',
            '集計・確認',
            '入荷反映',
            'CSV関連操作',
        ],
        planner: [
            '予定を追加（ドラッグ）',
            '倍率/総量を設定',
            '予定を移動',
            '1件削除 / 期間一括削除',
            '発注リストへ連携',
        ],
        'order-list': [
            '期間を指定',
            '必要量を計算',
            '在庫差し引きで不足判定',
            '発注量を確認',
            'コピー / 印刷',
        ],
        list: [
            '検索・絞り込み',
            '並び替え',
            '最近見たレシピ',
            'レシピを開く',
            '共有・公開設定',
            'メニュー（各ボタン）',
            'レシピ追加',
            '別画面へ移動',
        ],
    };

    const buttonHintsByView = {
        detail: '🇫🇷 French / 原文表示 / 公開中/非公開 / 編集 / 削除 / 🖨️ プレビュー / QRコード',
        create: 'レシピを保存 / タイトル / URL取り込み / 画像解析 / 🎤 / 🧮原価計算アシスト',
        edit: 'レシピを保存 / タイトル / 🎤 / 🧮原価計算アシスト / 追加 / 削除',
        data: 'ファイルを選択 / アップロード実行 / 未登録 / 登録 / 更新 / 重複アイテム / ゴミ箱',
        'data-management': 'ファイルを選択 / アップロード実行 / 未登録 / 登録 / 更新 / 重複アイテム / ゴミ箱',
        inventory: '保存 / 反映 / 集計 / ダウンロード',
        planner: 'レシピ検索 / ドラッグ&ドロップ / 倍率 or 総量 / ×削除 / 一括削除 / 発注リストへ',
        'order-list': '開始日 / 終了日 / リスト作成 / 残在庫 / 発注量 / コピー / プレビュー',
        list: '検索欄 / + レシピ追加 / 🟢 自分公開中 / 🌐 他ユーザー公開 / ☰ メニュー',
    };

    const optionItems = optionsByView[currentView] || optionsByView.list;
    const buttonHints = buttonHintsByView[currentView] || '対象のボタン名';

    const lines = [
        '断定ミスを避けるため、先に1ステップだけ確認します。',
    ];

    if (assessment?.top?.entry?.title) {
        lines.push(`いまの最有力候補: ${assessment.top.entry.title}`);
    }
    if (currentViewLabel) {
        lines.push(`現在画面として認識: ${currentViewLabel}`);
    }

    lines.push('まず、やりたいことに近い番号を1つ返してください。');
    optionItems.forEach((item, index) => {
        lines.push(`${index + 1}. ${item}`);
    });
    lines.push(`次に、押したボタン名を1つだけ教えてください（例: ${buttonHints}）。`);
    lines.push('最後に「期待した結果」と「実際の結果」を1行で送ってください。');
    lines.push('返信例: 「1 / 🇫🇷 French / 日本語のまま変わらない」');

    return lines;
};

export const findOperationKnowledge = ({ question, currentView, limit = 3 }) => {
    return rankOperationKnowledge({ question, currentView, limit }).map((item) => item.entry);
};

export const assessOperationKnowledge = ({ question, currentView, limit = 3 }) => {
    const hits = rankOperationKnowledge({ question, currentView, limit });
    if (hits.length === 0) {
        return {
            confidence: 'low',
            reason: 'no_match',
            shouldAskClarification: true,
            hits: [],
            top: null,
            alternatives: [],
            bestScore: 0,
            scoreGap: 0,
        };
    }

    const top = hits[0];
    const second = hits[1] || null;
    const scoreGap = top.score - (second?.score || 0);
    const keywordMatchCount = top.matchedKeywords.length;

    let confidence = 'low';
    if ((top.score >= 11 && keywordMatchCount >= 2) || (top.score >= 10 && top.titleMatched && keywordMatchCount >= 1)) {
        confidence = 'high';
    } else if (top.score >= 7 && keywordMatchCount >= 1) {
        confidence = 'medium';
    }

    const shouldAskClarification = (
        confidence === 'low'
        && hits.length > 1
        && scoreGap <= 1
        && !top.titleMatched
        && top.matchedKeywords.length <= 1
    );

    let reason = 'sufficient';
    if (shouldAskClarification) {
        reason = confidence === 'low' ? 'low_score' : 'ambiguous';
    }

    return {
        confidence,
        reason,
        shouldAskClarification,
        hits,
        top,
        alternatives: hits.slice(1),
        bestScore: top.score,
        scoreGap,
    };
};

export const formatOperationClarificationAnswer = ({
    assessment,
    currentViewLabel = '',
    currentView = '',
}) => {
    return buildClarificationLines({ assessment, currentViewLabel, currentView }).join('\n');
};

const MENU_BUTTON_DETAIL_RULES = [
    {
        label: 'Q&A',
        patterns: ['q&a', 'qa', 'q and a', '質問回答'],
        can: '別タブで `recipe.html` を開き、質問と回答を確認できます。',
        caution: '現在の画面はそのまま残り、Q&Aは別タブで開きます。',
        pitfall: 'ポップアップ/新規タブがブラウザ設定でブロックされると開けません。'
    },
    {
        label: 'アプリガイド',
        patterns: ['アプリガイド', 'マニュアル', '操作ガイド'],
        can: '別タブで `recipe_management.pdf` を開き、操作資料を閲覧できます。',
        caution: 'PDFは表示まで少し時間がかかることがあります。',
        pitfall: '通信状況が悪いとPDFが白画面のままになることがあります。再読み込みしてください。'
    },
    {
        label: 'Webから追加',
        patterns: ['webから追加', 'web追加', 'urlから追加', 'url取り込み'],
        can: 'URL取り込みモーダルを開き、Webページからレシピを作成できます（一覧画面で表示）。',
        caution: '一覧画面以外では表示されません。',
        pitfall: 'URLのコピー漏れや対象サイト未対応、保護サイト（403など）で取り込みに失敗することがあります。継続利用URLは管理者に申請して抽出ロジック調整の対象にしてください。'
    },
    {
        label: '画像から追加',
        patterns: ['画像から追加', '画像追加', '写真から追加', 'ocr'],
        can: '画像取り込みモーダルを開き、画像からレシピを抽出できます（一覧画面で表示）。',
        caution: '一覧画面以外では表示されません。',
        pitfall: '画質が低い画像、文字が小さい画像、情報が密集した手書き画像は抽出精度が下がります。'
    },
    {
        label: '在庫管理',
        patterns: ['在庫管理'],
        can: '在庫管理画面へ移動し、棚卸し・集計・在庫確認ができます。',
        caution: 'スマホ表示では操作しづらいためPC/タブレット推奨です。',
        pitfall: '月次や業者別の集計条件を変え忘れると見たい結果にならないことがあります。'
    },
    {
        label: '入荷PDF',
        patterns: ['入荷pdf', '入荷 pdf'],
        can: '入荷PDF画面へ移動し、PDFを解析して保存できます。',
        caution: '解析後に保存を押さないと在庫反映に使えません。',
        pitfall: '対応外フォーマットのPDFは解析に失敗することがあります。'
    },
    {
        label: '入荷在庫',
        patterns: ['入荷在庫'],
        can: '入荷在庫画面へ移動し、入荷データを在庫へ反映できます。',
        caution: '先に入荷PDFを保存しておく必要があります。',
        pitfall: '反映対象の選択ミスで意図しない在庫更新になることがあります。'
    },
    {
        label: '仕込みカレンダー',
        patterns: ['仕込みカレンダー', 'カレンダー'],
        can: '仕込みカレンダー画面へ移動し、日付ごとの予定を管理できます。',
        caution: '対象日付を確認してから登録・編集してください。',
        pitfall: '表示中の月を勘違いして別月に登録してしまうことがあります。'
    },
    {
        label: '発注リスト',
        patterns: ['発注リスト', '発注'],
        can: '発注リスト画面へ移動し、必要材料の確認・コピー・印刷ができます。',
        caution: '仕込みカレンダーの内容に応じてリスト内容が変わります。',
        pitfall: '期間や対象店舗の前提が違うと必要数がずれて見えることがあります。'
    },
    {
        label: 'データ管理',
        patterns: ['データ管理'],
        can: 'データ管理画面へ移動し、価格CSV・材料マスター・バックアップを操作できます。',
        caution: 'タブごとに対象データが異なるため、操作前にタブ名を確認してください。',
        pitfall: 'CSV取込タブとファイル操作タブを取り違えると意図どおり反映されません。'
    },
    {
        label: 'ユーザー管理',
        patterns: ['ユーザー管理', 'user management'],
        can: '管理者のみ表示され、ユーザー情報や権限設定を管理できます。',
        caution: '一般ユーザーには表示されません。',
        pitfall: '管理者権限の付与/解除を誤ると運用に影響が出ます。'
    },
    {
        label: 'API使用ログ',
        patterns: ['api使用ログ', 'apiログ'],
        can: '管理者のみ表示され、API利用状況やコストを確認できます。',
        caution: '一般ユーザーには表示されません。',
        pitfall: '期間フィルタ未設定のままだと必要なログが見つけづらくなります。'
    },
    {
        label: '一括削除 / 一括操作',
        patterns: ['一括削除', '一括操作', '選択モード', '複数削除', 'まとめて削除', '一括で消す'],
        can: '選択モードを開始し、複数レシピをまとめて削除/復元できます。',
        steps: [
            'レシピ一覧で ☰ スライダーを開き「一括削除」を押すと選択モードになります。',
            '削除したいレシピを複数選択します（必要なら「全選択」を使います）。',
            '一覧画面では「削除」を押すと、選択レシピはゴミ箱へ移動します（この段階では復元可能）。',
            'ゴミ箱画面では同じ入口が「一括操作」表示になり、「復元」または「完全削除」を選べます。',
            '完全削除は取り消せないため、件数と対象を確認してから確定します。'
        ],
        caution: '選択した件数を確認してから確定してください。',
        pitfall: '選択解除し忘れで意図しないレシピまで処理してしまうことがあります。'
    },
    {
        label: 'ゴミ箱',
        patterns: ['ゴミ箱', 'trash'],
        can: '削除済みレシピ一覧へ移動し、復元や完全削除ができます（一覧画面で表示）。',
        caution: '完全削除は取り消せません。',
        pitfall: '削除と完全削除を取り違えると復元できなくなります。'
    },
    {
        label: '一覧に戻る',
        patterns: ['一覧に戻る', 'ホーム', 'top'],
        can: 'レシピ一覧画面へ戻ります。',
        caution: '編集中の未保存内容は保持されない場合があります。',
        pitfall: '戻る前に保存していないと入力内容が消えることがあります。'
    },
    {
        label: 'ログアウト',
        patterns: ['ログアウト', 'logout', 'サインアウト'],
        can: '現在のアカウントをサインアウトします。',
        caution: '再開するには再ログインが必要です。',
        pitfall: '共有端末でログアウトし忘れると他者が操作できてしまいます。'
    },
];

const findMenuButtonDetailRule = (question) => {
    const text = String(question || '').toLowerCase();
    if (!text) return null;
    return MENU_BUTTON_DETAIL_RULES.find((rule) => (
        (rule.patterns || []).some((pattern) => text.includes(String(pattern || '').toLowerCase()))
    )) || null;
};

export const formatLocalOperationAnswer = ({ question, currentView, currentViewLabel = '', responseStyle = 'balanced' }) => {
    const assessment = assessOperationKnowledge({ question, currentView, limit: 2 });
    if (assessment.shouldAskClarification) {
        return formatOperationClarificationAnswer({
            assessment,
            currentViewLabel,
            currentView,
        });
    }

    const primary = assessment.top.entry;
    const isConcise = responseStyle === 'concise';
    const isDetailed = responseStyle === 'detailed';
    const isReasonQuestion = /理由|なぜ|なんで/.test(String(question || ''));
    if (primary.id === 'data_price_month_range_reason' || (primary.id === 'data_price_informart_extract' && isReasonQuestion)) {
        return '月初から月末で指定する理由は、毎月のデータを積み重ねる際に期間の重複（ダブり）を避けやすく、管理しやすいからです。';
    }
    if (primary.id === 'menu_slider_button_guide') {
        const matchedRule = findMenuButtonDetailRule(question);
        if (matchedRule) {
            const lines = [
                `「${matchedRule.label}」`,
                `できること: ${matchedRule.can}`,
            ];
            if (!isConcise) lines.push(`注意点: ${matchedRule.caution}`);
            if (isDetailed) lines.push(`よくある失敗: ${matchedRule.pitfall}`);
            if (Array.isArray(matchedRule.steps) && matchedRule.steps.length > 0) {
                lines.push('手順:');
                const stepLimit = isConcise ? 3 : matchedRule.steps.length;
                matchedRule.steps.slice(0, stepLimit).forEach((step, index) => {
                    lines.push(`${index + 1}. ${step}`);
                });
            }
            return lines.join('\n');
        }
    }

    const lines = [];
    lines.push(`最短手順（${primary.title}）:`);
    const stepLimit = isConcise ? 3 : primary.steps.length;
    primary.steps.slice(0, stepLimit).forEach((step, index) => {
        lines.push(`${index + 1}. ${step}`);
    });
    if (primary.notes && !isConcise) {
        lines.push(`つまずきやすい点: ${primary.notes}`);
    }

    if (isDetailed && assessment.alternatives[0]?.entry?.title) {
        lines.push(`別候補: ${assessment.alternatives[0].entry.title}`);
    }
    if (!isConcise) {
        lines.push('違っていたら「画面名 / 押したボタン / 実際の表示」を1行で送ってください。すぐ修正します。');
    }

    return lines.join('\n');
};

export const buildKnowledgeSnippet = ({ question, currentView }) => {
    const hits = rankOperationKnowledge({ question, currentView, limit: 3 });
    if (hits.length === 0) return '関連ナレッジなし';

    return hits.map((item, index) => {
        const entry = item.entry;
        const lines = [];
        lines.push(`候補${index + 1}: ${entry.title}`);
        lines.push(`推定スコア: ${item.score}`);
        lines.push(`一致キーワード: ${item.matchedKeywords.join(', ') || 'なし'}`);
        lines.push(`キーワード: ${(entry.keywords || []).join(', ')}`);
        lines.push('手順:');
        entry.steps.forEach((step, stepIndex) => {
            lines.push(`${stepIndex + 1}. ${step}`);
        });
        if (entry.notes) lines.push(`補足: ${entry.notes}`);
        return lines.join('\n');
    }).join('\n\n');
};

export { OPERATION_KB };
